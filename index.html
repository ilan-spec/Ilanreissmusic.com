<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ilan Reiss Music Player</title>
    
    <!-- iPhone Lock Screen Meta Tags (for Now Playing info) --><meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Ilan Reiss Music">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/IlanReiss/ilanreissmusic.com/main/cover.png"> <!-- Reference your image directly here --><meta name="theme-color" content="#008080"> <!-- Matches initial background --><!-- Font Awesome for icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: pan-y; /* Default: allow vertical scroll, but can be overridden */
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            color: #000;
            background: #008080;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Prevent browser touch gestures on the body */
        }

        .window {
            display: flex;
            flex-direction: column;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            position: absolute;
            min-width: 250px;
            min-height: 150px;
            z-index: 10; /* Default stacking order */
        }

        .window.active-window {
            z-index: 100; /* Bring active window to front */
        }
        
        .player-container {
            width: 90%;
            max-width: 600px;
            height: 70vh;
            max-height: 550px;
        }

        .title-bar {
            padding: 5px 8px;
            font-weight: 700;
            font-size: 1rem;
            color: #fff; 
            background: linear-gradient(to right, #000080, #1084d0);
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            touch-action: none; /* Crucial for touch drag */
        }
        
        .title-bar-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            margin-right: 5px;
        }
        
        .title-bar-buttons {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
        }

        .window-button {
            width: 18px;
            height: 18px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 12px;
            font-weight: 900;
            color: #000;
            text-align: center;
            line-height: 16px;
            cursor: pointer;
            flex-shrink: 0;
            touch-action: manipulation; /* Allow button tap, prevent accidental drag */
        }
        .window-button:active {
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
        }

        .content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden;
            border-top: 1px solid #808080;
        }
        
        .content-inner {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden;
        }

        #search-bar {
            width: 100%;
            padding: 8px 10px;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            background: #fff;
            color: #000;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
            flex-shrink: 0;
        }

        #search-bar::placeholder {
            color: #808080;
        }

        .file-browser {
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 10px;
            flex-grow: 1; 
            overflow-y: auto;
            touch-action: pan-y; /* Allow vertical scrolling inside file browser */
        }

        #file-list {
            list-style-type: none;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        #file-list li {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            border-radius: 0;
            cursor: pointer;
            transition: none;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            color: #000;
            background: transparent;
            border: 1px solid transparent;
            height: 100px;
        }
        
        #file-list li:hover {
            background: transparent;
        }

        #file-list li .file-icon {
            font-size: 2.5rem;
            color: #000080;
            margin-bottom: 8px;
            text-shadow: none;
        }

        #file-list li.active .file-icon {
            color: #ffffff;
        }

        #file-list li .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            color: #000;
            padding: 2px 4px;
        }

        #file-list li.active {
            background: #000080;
            color: #fff;
        }
        
        #file-list li.active .file-name {
             color: #fff;
        }

        .player-controls {
            flex-shrink: 0;
        }

        #now-playing {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin-bottom: 10px;
            padding: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #audio-player {
            width: 100%;
        }

        ::-webkit-scrollbar {
            width: 16px;
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-track {
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
        }
        
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background: repeating-linear-gradient(
                -45deg,
                #c0c0c0,
                #c0c0c0 2px,
                #404040 2px,
                #404040 4px,
                #fff 4px,
                #fff 6px
            );
            cursor: nwse-resize;
            z-index: 100;
            touch-action: none; /* Crucial for touch resize */
        }
        
        #visualizer-window {
            width: 350px;
            height: 200px;
            top: 20px;
            left: 20px;
            display: none;
        }
        
        #visualizer-canvas {
            width: 100%;
            height: 100%;
            background: #000;
            display: block;
        }
        
        #info-window {
            width: 300px;
            height: 250px;
            top: 150px;
            left: 100px;
            display: none;
        }
        
        #info-window .content {
            padding: 15px;
            font-size: 0.9rem;
        }
        
        #info-button {
            width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: #000080;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
            margin-top: 5px;
            align-self: flex-start;
        }
        #info-button:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }

        #digital-clock {
            position: fixed;
            bottom: 0;
            right: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            font-size: 1rem;
            font-weight: 600;
            z-index: 1000;
            border-bottom: none;
            border-right: none;
        }
        
        #color-picker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            z-index: 1000;
            border-bottom: none;
            border-left: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #color-picker-container label {
            font-size: 1rem;
            font-weight: 600;
        }
        
        #bg-color-picker {
            width: 40px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            cursor: pointer;
            padding: 0;
        }
        
        #bg-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #bg-color-picker::-webkit-color-swatch {
            border: none;
        }
    </style>
</head>
<body>

    <div class="player-container window">
        <div class="title-bar">
            <span class="title-bar-text">🎵 Ilan Reiss Music Player</span>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="player-container">X</button>
            </div>
        </div>
        
        <div class="content">
            <div class="player-controls">
                <span id="now-playing">Select a track to play</span>
                <audio id="audio-player" controls crossorigin="anonymous"></audio>
            </div>
            
            <div class="content-inner">
                <input type="text" id="search-bar" placeholder="Search tracks...">

                <div class="file-browser">
                    <ul id="file-list"></ul>
                </div>
                 <button id="info-button" class="window-button">i</button>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <div id="visualizer-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">🔊 Audio Visualizer</span>
            <div class="title-bar-buttons">
                <button id="toggle-visualizer-button" class="window-button">⇌</button>
                <button class="window-button close-button" data-target="visualizer-window">X</button>
            </div>
        </div>
        <div class="content" style="padding: 0; border: 2px inset #808080; border-top-color: #404040; border-left-color: #404040; border-right-color: #fff; border-bottom-color: #fff; background: #000;">
            <canvas id="visualizer-canvas"></canvas>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <div id="info-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">ℹ️ Information</span>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="info-window">X</button>
            </div>
        </div>
        <div class="content">
            <p><strong>Ilan Reiss Music Player</strong></p>
            <p>Version 2.0 (Enhanced Retro)</p>
            <br>
            <p>This music player streams files directly from the 'Audio' folder of the GitHub repository.</p>
            <br>
            <p>Use the color picker to change the background and visualizer theme!</p>
            <p>Click the '⇌' button in the visualizer window to change styles.</p>
            <br>
            <p><em>(You can edit this text in the ilanreissmusic.com.html file)</em></p>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <div id="digital-clock"></div>

    <div id="color-picker-container">
        <label for="bg-color-picker">BG:</label>
        <input type="color" id="bg-color-picker" value="#008080">
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Configuration & Elements ---
        const audioFiles = [
            "2 part shit.mp3", "42 cent.mp3", "67.mp3", "808 beat sample.mp3",
            "a break.mp3", "all me.mp3", "another one.mp3", "asher organ.mp3",
            "ass with potench.mp3", "bad one.mp3", "been a minu.mp3", "beeps.mp3",
            "before my set.mp3", "before you go.mp3", "black airforces.mp3",
            "bubs final.mp3", "bubs.mp3", "buds.mp3", "bullshittin.mp3",
            "candy shack.mp3", "chicos.mp3", "chilled.mp3", "com 303 sh.mp3",
            "corp. rework.mp3", "corp..mp3", "cya.mp3", "cypher chopped.mp3",
            "danklin.mp3", "day ones.mp3", "day today .mp3", "delete this track.mp3",
            "dub w.mp3", "easter.mp3", "ff.mp3", "flip.mp3", "fly guy.mp3",
            "for it.mp3", "for the car.mp3", "fridays.mp3", "fuckin idk.mp3",
            "funky.mp3", "gallery lazy break.mp3", "gallery.mp3", "giving in.mp3",
            "go 2.mp3", "goin crazy wit 10 racks.mp3", "goin crazy with 10 racks.mp3",
            "golf soundscape.mp3", "gover.mp3", "grizzlies ART.mp3", "grizzlies.mp3",
            "half life beat.mp3", "hammer down.mp3", "have it.mp3", "have to save.mp3",
            "hit the cart.mp3", "House on plane.mp3", "huh.mp3", "hyper fix.mp3",
            "i wanna.mp3", "insanity.mp3", "is ass.mp3", "jungled.mp3", "kenny.mp3",
            "kirked.mp3", "last of day.mp3", "lastly.mp3", "late.mp3", "lib beat.mp3",
            "locked.mp3", "lost it unfinished.mp3", "lyra demo.mp3", "ma.mp3",
            "making progress thru.mp3", "making progress.mp3", "mini 808.mp3",
            "MPC iPhone beat.mp3", "my amigo.mp3", "my sound scape.mp3",
            "new jersey club.mp3", "new setup.mp3", "niko again .mp3",
            "niko again unfinished.mp3", "niko is talking.mp3", "not done beat.mp3",
            "not thru.mp3", "not trash.mp3", "null.mp3", "number 3 shit.mp3",
            "On plane shiz.mp3", "postd.mp3", "practice.mp3", "quiky.mp3",
            "rabbits.mp3", "read up.mp3", "recipe.mp3", "redo.mp3", "reggae.mp3",
            "reggetons.mp3", "Reiss_Soundscape_edit.mp3", "Reiss_soundscape_raw.mp3",
            "rick poppa.mp3", "rythm.mp3", "same goal.mp3", "saturday morning.mp3",
            "saturn.mp3", "save rq.mp3", "saved it.mp3", "serup.mp3",
            "shit is trash.mp3", "shortest beat.mp3", "show class.mp3",
            "show trash.mp3", "slash slowed.mp3", "slash.mp3", "slow jam 2.mp3",
            "slow ride.mp3", "snippes.mp3", "soundbath 2.mp3", "soundbath.mp3",
            "SP iPhone sample.mp3", "spit it out.mp3", "standing in the rain.mp3",
            "starterd.mp3", "sue nami.mp3", "surfin.mp3", "swang.mp3",
            "swing song w eli.mp3", "synth demo.mp3", "take 2.mp3", "techno.mp3",
            "that way.mp3", "the monitor.mp3", "the worst beat ever.mp3",
            "this again.mp3", "threw together.mp3", "throw it up.mp3",
            "thursday.mp3", "trios.mp3", "trump-pets.mp3", "un house.mp3",
            "w issy.mp3", "watch it go.mp3", "week from today.mp3",
            "what am i doing.mp3", "what is this.mp3", "z style.mp3"
        ];

        const audioPlayer = document.getElementById('audio-player');
        const fileListElement = document.getElementById('file-list');
        const nowPlayingElement = document.getElementById('now-playing');
        const searchBar = document.getElementById('search-bar');
        
        const playerContainer = document.querySelector('.player-container');
        const visualizerWindow = document.getElementById('visualizer-window');
        const infoWindow = document.getElementById('info-window');
        const infoButton = document.getElementById('info-button');
        const digitalClock = document.getElementById('digital-clock');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const toggleVisualizerButton = document.getElementById('toggle-visualizer-button');
        
        const canvas = document.getElementById('visualizer-canvas');
        const ctx = canvas.getContext('2d');
        
        let visualizerColor = '#00FFFF'; // Initial color for visualizer
        let activeVisualizer = 'particleWave'; // 'particleWave' or 'retroWaveform'

        // --- Audio Context Setup ---
        let audioContext, analyser, source;
        let frequencyData, timeDomainData;
        let bufferLength;
        let visualizerActive = false;

        function setupAudioContext() {
            if (audioContext) return;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048; // Good for both frequency and time domain
            
            source = audioContext.createMediaElementSource(audioPlayer);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            
            bufferLength = analyser.frequencyBinCount; // half of fftSize
            frequencyData = new Uint8Array(bufferLength);
            timeDomainData = new Uint8Array(bufferLength);
        }

        // --- Visualizer Implementations ---

        // Particle System for Particle Wave Visualizer
        const particles = [];
        const maxParticles = 200;

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = (Math.random() * 3) + 0.5;
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.life = Math.random() * 100 + 100; // Longer life for smoother fade
                this.size = Math.random() * 2 + 1; // 1-3px
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 1;
                this.vx *= 0.99;
                this.vy *= 0.99;
            }

            draw(ctx) {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = Math.max(0, this.life / 200);
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawParticleWaveVisualizer() {
            if (!visualizerActive) return;
            
            requestAnimationFrame(drawParticleWaveVisualizer);
            
            analyser.getByteFrequencyData(frequencyData);
            
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; // Slight fade for trails
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // Calculate average frequencies for control
            let bass = 0, mids = 0, highs = 0;
            const bassRange = [0, Math.floor(bufferLength * 0.05)]; // ~0-500Hz
            const midRange = [Math.floor(bufferLength * 0.05), Math.floor(bufferLength * 0.2)]; // ~500Hz-2kHz
            const highRange = [Math.floor(bufferLength * 0.2), Math.floor(bufferLength * 0.4)]; // ~2kHz-4kHz

            for (let i = bassRange[0]; i < bassRange[1]; i++) bass += frequencyData[i];
            for (let i = midRange[0]; i < midRange[1]; i++) mids += frequencyData[i];
            for (let i = highRange[0]; i < highRange[1]; i++) highs += frequencyData[i];

            let bassAvg = bass / (bassRange[1] - bassRange[0]) || 0;
            let midsAvg = mids / (midRange[1] - midRange[0]) || 0;
            let highsAvg = highs / (highRange[1] - highRange[0]) || 0;

            // Particle spawning (more responsive to mids)
            const spawnRate = Math.floor(midsAvg / 30); // Adjust divisor for sensitivity
            if (particles.length < maxParticles) {
                for (let i = 0; i < spawnRate; i++) {
                    particles.push(new Particle(centerX, centerY, visualizerColor));
                }
            }
            
            // Update and draw particles
            ctx.globalAlpha = 1.0;
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw(ctx);
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }

            // Draw pulsing circle (responsive to bass)
            const baseRadius = Math.min(canvas.width, canvas.height) / 8;
            const pulseRadius = (bassAvg / 255) * (baseRadius * 0.6); // Max pulse for bass
            const currentRadius = baseRadius + pulseRadius;
            
            ctx.shadowColor = visualizerColor;
            ctx.shadowBlur = 20;
            ctx.strokeStyle = visualizerColor;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, currentRadius, 0, Math.PI * 2);
            ctx.stroke();

            // Draw radial waves (responsive to mids)
            const numWaves = 3;
            const waveAmplitude = (midsAvg / 255) * (baseRadius / 4);
            for (let i = 0; i < numWaves; i++) {
                const waveRadius = currentRadius + (i + 1) * (baseRadius / 3) + Math.sin(Date.now() * 0.005 + i) * waveAmplitude;
                ctx.globalAlpha = 0.4 - (i * 0.1); // Fade outer waves
                ctx.beginPath();
                ctx.arc(centerX, centerY, waveRadius, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Inner core fill (subtle)
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = visualizerColor;
            ctx.beginPath();
            ctx.arc(centerX, centerY, Math.max(0, currentRadius * 0.7), 0, Math.PI * 2);
            ctx.fill();
            
            // Reset context
            ctx.globalAlpha = 1.0;
            ctx.shadowBlur = 0;
        }

        // Retro Waveform Visualizer
        function drawRetroWaveformVisualizer() {
            if (!visualizerActive) return;

            requestAnimationFrame(drawRetroWaveformVisualizer);

            analyser.getByteTimeDomainData(timeDomainData); // Use time domain for waveform

            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            
            ctx.fillStyle = '#000'; // Clear background
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = 3; // Smoother line
            ctx.strokeStyle = visualizerColor;
            ctx.shadowColor = visualizerColor;
            ctx.shadowBlur = 10;

            ctx.beginPath();
            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                const v = timeDomainData[i] / 128.0;
                const y = v * canvas.height / 2;

                if(i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();

            // Gradient fill underneath
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, visualizerColor);
            gradient.addColorStop(0.5, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, visualizerColor);

            ctx.fillStyle = gradient;
            ctx.globalAlpha = 0.2; // Subtle fill
            ctx.beginPath();
            x = 0;
            ctx.moveTo(0, canvas.height); // Start at bottom left
            for(let i = 0; i < bufferLength; i++) {
                const v = timeDomainData[i] / 128.0;
                const y = v * canvas.height / 2;
                ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height); // Go to bottom right
            ctx.closePath();
            ctx.fill();


            ctx.globalAlpha = 1.0;
            ctx.shadowBlur = 0;
        }

        function startVisualizerLoop() {
            if (activeVisualizer === 'particleWave') {
                drawParticleWaveVisualizer();
            } else {
                drawRetroWaveformVisualizer();
            }
        }

        // --- Window Management ---

        let activeWindow = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffsetX, dragOffsetY;
        let resizeStartX, resizeStartY;
        let initialWidth, initialHeight;

        // Bring window to front on interaction
        document.querySelectorAll('.window').forEach(windowEl => {
            windowEl.addEventListener('mousedown', () => bringWindowToFront(windowEl));
            windowEl.addEventListener('touchstart', () => bringWindowToFront(windowEl), { passive: true });
        });

        function bringWindowToFront(windowEl) {
            document.querySelectorAll('.window').forEach(win => {
                win.classList.remove('active-window');
            });
            windowEl.classList.add('active-window');
        }

        function handleDragStart(e, windowEl) {
            // Check if it's a close/toggle button
            if (e.target.classList.contains('window-button')) return;

            isDragging = true;
            activeWindow = windowEl;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            dragOffsetX = clientX - windowEl.offsetLeft;
            dragOffsetY = clientY - windowEl.offsetTop;
            
            document.body.style.cursor = 'move';
            if (e.cancelable) e.preventDefault(); // Prevent accidental scroll on touch
        }

        function handleDragMove(e) {
            if (!isDragging || !activeWindow) return;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let newX = clientX - dragOffsetX;
            let newY = clientY - dragOffsetY;
            
            newX = Math.max(0, Math.min(newX, window.innerWidth - activeWindow.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - activeWindow.offsetHeight));

            activeWindow.style.left = newX + 'px';
            activeWindow.style.top = newY + 'px';
            if (e.cancelable) e.preventDefault(); // Prevent accidental scroll on touch
        }

        function handleResizeStart(e, windowEl) {
            isResizing = true;
            activeWindow = windowEl;

            resizeStartX = e.touches ? e.touches[0].clientX : e.clientX;
            resizeStartY = e.touches ? e.touches[0].clientY : e.clientY;
            initialWidth = windowEl.offsetWidth;
            initialHeight = windowEl.offsetHeight;

            document.body.style.cursor = 'nwse-resize';
            if (e.cancelable) e.preventDefault(); // Prevent accidental scroll on touch
        }

        function handleResizeMove(e) {
            if (!isResizing || !activeWindow) return;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let newWidth = initialWidth + (clientX - resizeStartX);
            let newHeight = initialHeight + (clientY - resizeStartY);

            newWidth = Math.max(activeWindow.style.minWidth ? parseFloat(activeWindow.style.minWidth) : 250, newWidth);
            newHeight = Math.max(activeWindow.style.minHeight ? parseFloat(activeWindow.style.minHeight) : 150, newHeight);

            activeWindow.style.width = newWidth + 'px';
            activeWindow.style.height = newHeight + 'px';
            if (e.cancelable) e.preventDefault(); // Prevent accidental scroll on touch
        }

        function handleEnd() {
            isDragging = false;
            isResizing = false;
            activeWindow = null;
            document.body.style.cursor = 'default';
        }

        // Apply drag/resize to all windows
        document.querySelectorAll('.window').forEach(windowEl => {
            const titleBar = windowEl.querySelector('.title-bar');
            const resizeHandle = windowEl.querySelector('.resize-handle');

            titleBar.addEventListener('mousedown', (e) => handleDragStart(e, windowEl));
            titleBar.addEventListener('touchstart', (e) => handleDragStart(e, windowEl), { passive: false });

            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', (e) => handleResizeStart(e, windowEl));
                resizeHandle.addEventListener('touchstart', (e) => handleResizeStart(e, windowEl), { passive: false });
            }
        });

        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('mousemove', handleResizeMove);
        document.addEventListener('touchmove', handleResizeMove, { passive: false });
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);


        // --- Initialize Window Positions ---
        playerContainer.style.left = (window.innerWidth - playerContainer.offsetWidth) / 2 + 'px';
        playerContainer.style.top = (window.innerHeight - playerContainer.offsetHeight) / 2 + 'px';
        
        visualizerWindow.style.left = '20px';
        visualizerWindow.style.top = '20px';
        infoWindow.style.left = (window.innerWidth - infoWindow.offsetWidth) / 2 + 'px';
        infoWindow.style.top = (window.innerHeight - infoWindow.offsetHeight) / 2 + 'px';

        // Set initial active window
        bringWindowToFront(playerContainer);


        // --- Populate File List ---
        audioFiles.forEach(file => {
            const li = document.createElement('li');
            li.innerHTML = `
                <i class="fas fa-music file-icon"></i>
                <span class="file-name">${file.replace('.mp3', '')}</span>
            `;
            li.dataset.filename = file;
            fileListElement.appendChild(li);
        });

        // --- Event Listeners ---

        fileListElement.addEventListener('click', (event) => {
            const clickedLi = event.target.closest('li');
            if (clickedLi) {
                const filename = clickedLi.dataset.filename;
                audioPlayer.src = 'Audio/' + filename;
                
                setupAudioContext(); // Ensure context is ready
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                audioPlayer.play();
                nowPlayingElement.textContent = clickedLi.querySelector('.file-name').textContent;
                
                const currentActive = fileListElement.querySelector('.active');
                if (currentActive) {
                    currentActive.classList.remove('active');
                }
                clickedLi.classList.add('active');
                
                visualizerWindow.style.display = 'flex';
                visualizerActive = true;
                startVisualizerLoop();
            }
        });
        
        audioPlayer.addEventListener('pause', () => {
            visualizerActive = false;
        });
        
        audioPlayer.addEventListener('play', () => {
            if (audioContext) {
                audioContext.resume();
                visualizerActive = true;
                startVisualizerLoop();
            }
        });

        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            fileListElement.querySelectorAll('li').forEach(fileLi => {
                const fileName = fileLi.querySelector('.file-name').textContent.toLowerCase();
                fileLi.style.display = fileName.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        audioPlayer.addEventListener('ended', () => {
            const currentActive = fileListElement.querySelector('.active');
            if (currentActive) {
                let nextTrack = currentActive.nextElementSibling;
                if (!nextTrack) {
                    nextTrack = fileListElement.firstElementChild;
                }
                if (nextTrack) {
                    nextTrack.click();
                }
            }
        });
        
        infoButton.addEventListener('click', () => {
            infoWindow.style.display = 'flex';
            bringWindowToFront(infoWindow);
        });
        
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetWindowId = e.target.dataset.target;
                const windowToClose = document.getElementById(targetWindowId);
                if (windowToClose) {
                    windowToClose.style.display = 'none';
                    if (targetWindowId === 'visualizer-window') {
                        visualizerActive = false;
                    }
                }
            });
        });

        toggleVisualizerButton.addEventListener('click', () => {
            activeVisualizer = (activeVisualizer === 'particleWave') ? 'retroWaveform' : 'particleWave';
            if (visualizerActive) { // Only restart if already playing
                startVisualizerLoop();
            }
        });

        // --- Color Conversion Helper (Hex to HSL) ---
        function hexToHSL(H) {
            let r = 0, g = 0, b = 0;
            if (H.length == 4) { r = "0x" + H[1] + H[1]; g = "0x" + H[2] + H[2]; b = "0x" + H[3] + H[3]; }
            else if (H.length == 7) { r = "0x" + H[1] + H[2]; g = "0x" + H[3] + H[4]; b = "0x" + H[5] + H[6]; }
            r /= 255; g /= 255; b /= 255;
            let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
            if (delta == 0) h = 0; else if (cmax == r) h = ((g - b) / delta) % 6;
            else if (cmax == g) h = (b - r) / delta + 2; else h = (r - g) / delta + 4;
            h = Math.round(h * 60); if (h < 0) h += 360;
            l = (cmax + cmin) / 2;
            s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
            s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
            return {h, s, l};
        }

        // --- Background Color Picker ---
        bgColorPicker.addEventListener('input', (e) => {
            const newColor = e.target.value;
            document.body.style.background = newColor;
            
            const hsl = hexToHSL(newColor);
            visualizerColor = `hsl(${hsl.h}, 100%, 65%)`; // Adjust lightness for visualizer if needed
        });

        // --- Digital Clock ---
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12;
            
            digitalClock.textContent = `${hours}:${minutes} ${ampm}`;
        }
        setInterval(updateClock, 1000);
        updateClock(); // Initial call

        // Initial visualizer color sync
        const initialBgColor = bgColorPicker.value;
        const initialHsl = hexToHSL(initialBgColor);
        visualizerColor = `hsl(${initialHsl.h}, 100%, 65%)`;

        // Load the provided image into a hidden img tag to ensure it's loaded for iPhone
        const lockScreenImage = new Image();
        lockScreenImage.src = "https://raw.githubusercontent.com/IlanReiss/ilanreissmusic.com/main/cover.png";
        lockScreenImage.style.display = 'none';
        document.body.appendChild(lockScreenImage);
    });
</script>
</body>
</html>


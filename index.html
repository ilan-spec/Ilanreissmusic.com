<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- 
      Viewport meta tag: 
      - width=device-width: Sets the viewport width to the device's screen width.
      - initial-scale=1.0: Sets the initial zoom level to 100%.
      - user-scalable=no, maximum-scale=1.0: Prevents users from zooming, which is crucial for a full-screen app-like experience, especially on mobile.
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Ilan Reiss Music Player</title>
    
    <!-- iOS & PWA Goodies -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Ilan Reiss Music">
    <!-- Links to the 'cover.png' image for the app icon when added to the home screen -->
    <link rel="apple-touch-icon" href="cover.png"> 

    <!-- Theme Color: Sets the color of the browser UI (like the status bar on mobile) -->
    <meta name="theme-color" content="#008080"> 

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Import the 'Inter' font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* Global reset and base settings */
        * {
            box-sizing: border-box; /* Modern box model */
            margin: 0;
            padding: 0;
            touch-action: pan-y; /* Allow vertical scrolling by default */
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            color: #000;
            background: #008080;
            overflow: hidden; /* Prevent body scrolling on desktop */
            height: 100vh; /* Full viewport height */
            user-select: none; /* Disable text selection */
            -webkit-user-select: none; /* Safari compatibility */
            touch-action: none; /* Disable all browser touch gestures (pinch-zoom, etc.) */
        }

        /* --- Window System --- */
        .window {
            display: flex;
            flex-direction: column;
            background: #c0c0c0; /* Classic Windows grey */
            /* 3D border effect */
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000; /* Drop shadow */
            position: absolute;
            min-width: 300px; 
            min-height: 200px; 
            z-index: 10; /* Default stacking order */
        }
 
        /* Active (top) window is brought to the front */
        .window.active-window {
            z-index: 100; 
        }
        
        /* Main player window specific styles */
        .player-container {
            width: 90%;
            max-width: 800px; 
            height: 85vh; 
            max-height: 750px; 
            min-width: 450px; 
            min-height: 550px; 
        }
 
        /* Title bar for dragging */
        .title-bar {
            padding: 5px 8px;
            font-weight: 700;
            font-size: 1rem;
            color: #fff; 
            background: linear-gradient(to right, #000080, #1084d0); /* Windows blue gradient */
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent title bar from shrinking */
            touch-action: none; /* Critical for touch-based dragging */
        }
        
        .title-bar-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* ... if text is too long */
            flex-grow: 1;
            margin-right: 5px;
        }
        
        .title-bar-buttons {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
        }

        /* Standard 3D buttons (minimize, close, etc.) */
        .window-button {
            width: 18px;
            height: 18px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 12px;
            font-weight: 900;
            color: #000;
            text-align: center;
            line-height: 16px;
            cursor: pointer;
            flex-shrink: 0;
            touch-action: manipulation; /* Allow tapping without triggering parent drag */
        }
        /* "Pressed" state for buttons */
        .window-button:active, .window-button.active {
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
        }

        /* --- Main Player Content --- */
        .content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden; /* Important for layout */
            border-top: 1px solid #808080;
        }
        
        .content-inner {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden;
        }
        
        .search-sort-container {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            align-items: center;
        }

        /* "Inset" text field style */
        #search-bar {
            flex-grow: 1; 
            padding: 8px 10px;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            background: #fff;
            color: #000;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
        }
        
        .sort-button {
             width: 40px;
             height: 34px; 
             padding: 0;
             font-weight: 700;
             font-size: 11px; 
        }

        #search-bar::placeholder {
            color: #808080;
        }
        
        /* Main file list area */
        .file-browser {
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 10px;
            flex-grow: 1; 
            overflow-y: auto; /* Allow vertical scrolling */
            touch-action: pan-y; /* Enable vertical scroll on touch */
        }
        
        /* Style for both track and mix lists */
        #file-list, #mix-list {
            list-style-type: none;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Responsive grid */
            gap: 15px;
        }
        
        #mix-list {
            display: none; /* Hidden by default */
        }

        #file-list li, #mix-list li {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            color: #000;
            background: transparent;
            border: 1px solid transparent;
            height: 100px;
            -webkit-touch-callout: none; /* Disable context menu bubble on iOS */
        }
        
        #file-list li:hover, #mix-list li:hover {
            background: transparent; /* Simple selection style */
        }

        #file-list li .file-icon, #mix-list li .file-icon {
            font-size: 2.5rem;
            color: #000080;
            margin-bottom: 8px;
        }

        #file-list li.active .file-icon, #mix-list li.active .file-icon {
            color: #ffffff;
        }

        #file-list li .file-name, #mix-list li .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            color: #000;
            padding: 2px 4px;
        }

        /* "Selected" item style */
        #file-list li.active, #mix-list li.active {
            background: #000080;
            color: #fff;
        }
        
        #file-list li.active .file-name, #mix-list li.active .file-name {
             color: #fff;
        }
        
        .player-controls {
            flex-shrink: 0;
        }
        
        .player-bottom-buttons {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-top: 5px;
            gap: 10px;
        }

        #now-playing {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin-bottom: 10px;
            padding: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #audio-player {
            width: 100%;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar {
            width: 16px;
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-track {
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
        }
        
        /* Draggable resize handle */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background: repeating-linear-gradient(
                -45deg,
                #c0c0c0,
                #c0c0c0 2px,
                #404040 2px,
                #404040 4px,
                #fff 4px,
                #fff 6px
            );
            cursor: nwse-resize;
            z-index: 100;
            touch-action: none; /* Critical for touch resize */
        }
        
        /* --- Visualizer Window --- */
        #visualizer-window {
            width: 350px;
            height: 200px;
            top: 20px;
            left: 20px;
            display: none; /* Hidden by default */
        }
        
        #visualizer-canvas {
            width: 100%;
            height: 100%;
            background: #000;
            display: block;
        }

        #visualizer-tabs {
            display: flex;
            flex-grow: 1; 
            margin-right: 5px;
            justify-content: flex-start; 
        }
        .visualizer-tab {
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            padding: 3px 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 2px;
            color: #000;
            touch-action: manipulation;
        }
        .visualizer-tab.active {
            background: #000080;
            color: #fff;
            border-bottom: none;
            position: relative;
            top: 1px;
        }
        /* Override button style for tabs */
        .visualizer-tab.window-button {
             width: auto;
             height: auto;
             line-height: normal;
        }

        /* --- Info Window --- */
        #info-window {
            width: 300px;
            height: 250px;
            top: 150px;
            left: 100px;
            display: none;
        }
        
        #info-window .content {
            padding: 15px;
            font-size: 0.9rem;
        }

        #info-window p {
            margin-bottom: 8px;
        }
        
        /* Buttons at the bottom of the main player */
        #info-button, #open-playlists-button, #add-track-now-playing {
            width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: #000080;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        #info-button:active, #open-playlists-button:active, #add-track-now-playing:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }
        #open-playlists-button {
            font-size: 12px; /* Folder icon */
        }
        #add-track-now-playing {
            font-size: 16px; /* Plus icon */
            line-height: 22px;
        }

        /* --- Bottom Bar Elements --- */
        #digital-clock {
            position: fixed;
            bottom: 0;
            right: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            font-size: 1rem;
            font-weight: 600;
            z-index: 1000;
            border-bottom: none;
            border-right: none;
        }
        
        #color-picker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            z-index: 1000;
            border-bottom: none;
            border-left: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #color-picker-container label {
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* Inset color picker */
        #bg-color-picker {
            width: 40px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            cursor: pointer;
            padding: 0;
        }
        /* Style for color picker internals */
        #bg-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #bg-color-picker::-webkit-color-swatch {
            border: none;
        }

        /* Minimized icon "buttons" */
        #minimized-player-icon {
            width: 25px; 
            height: 25px; 
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem; 
            color: #000080;
            margin-left: 10px; 
        }
        #minimized-player-icon:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }
        
        /* --- DJ App Styles --- */
        #open-dj-app-icon {
            width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #000080;
            margin-left: 10px;
        }
        #open-dj-app-icon:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }
        
        #minimized-dj-icon {
             width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #000080;
            margin-left: 10px;
        }
        #minimized-dj-icon:active {
              border-top: 2px solid #404040;
             border-left: 2px solid #404040;
             border-right: 2px solid #fff;
             border-bottom: 2px solid #fff;
         }
         
         /* DJ window container */
         #dj-app-window {
             width: 80vw; 
             max-width: 900px; 
             height: 550px; 
             min-width: 600px;
             min-height: 400px;
            display: none; 
        }
        
        /* Main layout: [Deck A] [Library] [Deck B] */
        #dj-app-window .content {
            flex-direction: row; 
            overflow: hidden;
            background: #808080; 
            padding-bottom: 10px; 
        }
        
        .deck-container {
            flex: 1.5; /* Decks take up less space */
            display: flex;
            flex-direction: column;
            background: #c0c0c0;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 10px;
            gap: 10px;
        }
        
        #dj-library-container {
            flex: 2; /* Library is wider */
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            overflow: hidden;
        }
        
        #dj-library-header {
            padding: 5px;
            border-bottom: 2px solid #c0c0c0;
            flex-shrink: 0;
        }
        
        #dj-library-list {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            padding: 5px;
            touch-action: pan-y;
        }
        
        #dj-library-list li {
            padding: 6px 8px;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #dj-library-list li:hover {
            background: #e0e0e0;
        }
        
        #dj-library-list li.selected {
            background: #000080;
            color: #fff;
        }
        
        .dj-track-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        
        .dj-track-bpm {
            flex-shrink: 0;
            color: #404040;
            border: 1px solid #808080;
            width: 60px; 
            text-align: right;
            padding: 2px;
            font-size: 0.85rem;
            -moz-appearance: textfield; /* Firefox hide number arrows */
        }
        
        /* Hide number input arrows in Chrome/Safari */
        .dj-track-bpm::-webkit-outer-spin-button,
        .dj-track-bpm::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #dj-library-list li.selected .dj-track-bpm {
            color: #000; 
            background: #fff;
        }
        
        /* Track display with spinning platter */
        .track-name-display {
            height: 40px;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 5px 8px; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden; 
        }
        
        /* Spinning animation */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* The draggable platter */
        .scrub-platter {
            width: 30px;
            height: 30px;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            cursor: grab;
            touch-action: none; /* Disable scrolling when scrubbing */
            animation: spin 2s linear infinite paused; /* Paused by default */
        }
        .scrub-platter:active {
            cursor: grabbing;
        }
        
        .platter-spindle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #c0c0c0;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .track-name-text {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .load-info-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .load-button {
            height: 40px; 
            font-weight: 700;
            flex-grow: 1; 
        }
        
        .current-bpm-display {
            font-weight: 700;
            font-size: 1.1rem;
            color: #000;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 8px 10px;
            min-width: 90px; 
            text-align: center;
            flex-shrink: 0;
            height: 40px; 
        }
        
        /* Main scrub bar (horizontal range input) */
        .scrub-bar {
            width: 100%;
            height: 20px;
            cursor: pointer;
        }
        
        .deck-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .deck-controls .window-button {
            width: 45px; /* Sized to fit new buttons */
            height: 30px;
        }
        
        /* "Active" state for the Echo button */
        .deck-controls .echo-button.active {
            background: #000080;
            color: #fff;
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
        }

        /* --- EQ Controls --- */
        .eq-controls {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 5px 0;
            border-top: 2px inset #808080;
            margin-top: 10px;
            gap: 5px; 
            flex-wrap: wrap; 
        }
        .eq-dial {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-weight: 600;
            font-size: 0.8rem; 
            gap: 5px;
            flex-basis: 50px; /* Base width for 4 knobs */
            flex-grow: 1; 
        }
        /* Horizontal slider "knobs" */
        .eq-slider { 
            -webkit-appearance: none;
            appearance: none;
            width: 100%; 
            max-width: 70px; 
            height: 15px;
            background: #808080;
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
            outline: none;
            cursor: pointer;
        }
        /* 3D thumb for sliders */
        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px; 
            height: 20px; 
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            cursor: pointer;
        }
        .eq-slider::-moz-range-thumb {
            width: 15px; 
            height: 20px; 
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            border-radius: 0;
        }

        
        /* --- Vertical Sliders Container --- */
        .deck-sliders {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-grow: 1;
            padding: 10px 0;
        }
        
        .volume-slider-container, .bpm-slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .bpm-slider-container .bpm-label-group {
            display: flex;
            gap: 5px;
            align-items: baseline;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .bpm-display {
            font-size: 0.9rem;
            font-weight: 700;
            color: #000080;
            min-width: 40px; 
            text-align: center;
        }
        
        /* Vertical sliders (Volume, BPM) */
        .volume-slider, .bpm-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 15px;
            background: #808080;
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
            outline: none;
            writing-mode: vertical-lr; /* Make vertical */
            transform: rotate(180deg); /* Point up */
            width: 20px; 
            height: 150px; 
        }
        
        /* 3D thumb for vertical sliders */
        .volume-slider::-webkit-slider-thumb, .bpm-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px; /* Wider thumb */
            height: 15px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb, .bpm-slider::-moz-range-thumb {
            width: 30px;
            height: 15px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            cursor: pointer;
            border-radius: 0;
        }
        
        
        /* --- Playlist Window --- */
        #playlist-window {
            width: 500px;
            height: 400px;
            top: 50px;
            left: 50px;
            display: none;
        }
        #playlist-window .content {
            flex-direction: row;
            gap: 0;
        }
        #playlist-list-container {
            width: 150px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #808080;
            padding-right: 10px;
            gap: 10px;
        }
        #playlist-tracks-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding-left: 10px;
            gap: 10px;
        }
        #playlist-list-header, #playlist-tracks-header {
            font-weight: 700;
            padding-bottom: 5px;
            border-bottom: 1px solid #808080;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #playlist-list {
            flex-grow: 1;
            overflow-y: auto;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            list-style: none;
            padding: 5px;
            touch-action: pan-y;
        }
        #playlist-list li {
            padding: 8px 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        #playlist-list li:hover {
            background: #e0e0e0;
        }
        #playlist-list li.selected {
            background: #000080;
            color: #fff;
        }
        #playlist-buttons {
            display: flex;
            gap: 5px;
        }
        #playlist-buttons .window-button {
            width: 20px;
            height: 20px;
            font-size: 14px;
            line-height: 18px;
        }
        #playlist-tracks {
            flex-grow: 1;
            overflow-y: auto;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            list-style: none;
            padding: 5px;
            touch-action: pan-y;
        }
        #playlist-tracks li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 5px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        #playlist-tracks li:hover {
            background: #e0e0e0;
        }
        .playlist-track-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .playlist-track-remove {
            width: 18px;
            height: 18px;
            font-size: 12px;
            line-height: 16px;
            flex-shrink: 0;
            margin-left: 10px;
        }
        
        /* --- Track Context Menu (Right-click menu) --- */
        #track-context-menu {
            position: absolute;
            display: none;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            z-index: 1000;
            font-size: 0.9rem;
            min-width: 150px;
        }
        #track-context-menu ul {
            list-style: none;
        }
        #track-context-menu li {
            padding: 8px 12px;
            cursor: pointer;
            position: relative; /* For submenu positioning */
        }
        #track-context-menu li:hover {
            background: #000080;
            color: #fff;
        }
        /* Submenu for adding to playlists */
        #add-to-playlist-submenu {
            position: absolute;
            display: none;
            left: 100%; /* Default position (right) */
            top: -2px; 
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            min-width: 150px;
        }
        #add-to-playlist-menu:hover #add-to-playlist-submenu {
            display: block;
        }
        
        /* --- Custom Modal Styles (for alerts/confirms) --- */
        .custom-modal-overlay {
            display: none; 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.4); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center;
        }
        .custom-modal-window {
            background: #c0c0c0; 
            border-top: 2px solid #fff; 
            border-left: 2px solid #fff; 
            border-right: 2px solid #404040; 
            border-bottom: 2px solid #404040; 
            box-shadow: 1px 1px 0 1px #000; 
            min-width: 250px; 
            max-width: 90%; 
            padding: 0;
        }
        .custom-modal-titlebar {
            padding: 5px 8px; 
            font-weight: 700; 
            color: #fff; 
            background: linear-gradient(to right, #000080, #1084d0);
        }
        .custom-modal-message {
            padding: 20px 15px; 
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 50vh;
            overflow-y: auto;
        }
        .custom-modal-buttons {
            display: flex; 
            justify-content: center; 
            padding: 0 10px 10px 10px;
            gap: 10px;
        }
        .custom-modal-buttons .window-button {
            width: 80px; 
            height: 25px; 
            line-height: 22px; 
            font-size: 0.9rem;
        }


        /* --- Responsive Media Query (for mobile) --- */
        @media (max-width: 768px) {
            body {
                overflow: auto; /* Allow scrolling on mobile */
                height: auto;
                min-height: 100vh;
                padding: 5px;
                padding-bottom: 120px; /* Space for bottom bars */
            }
            /* Stack windows vertically */
            .window {
                position: relative; 
                width: 100% !important; 
                height: auto !important; 
                min-width: 95vw;
                left: 0 !important;
                top: 0 !important;
                margin-bottom: 10px;
                box-shadow: 1px 1px 0 1px #000; 
            }
            .resize-handle { display: none; } /* No resizing on mobile */
            .title-bar { cursor: default; } /* No dragging on mobile */
            
            .player-container {
                min-height: 0; 
                height: auto;
            }

            .file-browser {
                min-height: 300px; /* Ensure file list is usable */
            }

            /* DJ App Mobile Layout: */
            #dj-app-window .content {
                flex-direction: column; /* Stack vertically */
                height: auto;
            }
            #dj-library-container {
                order: 1; /* Library first */
                flex-basis: 100%; 
                height: 250px; /* Fixed height for library */
            }
            /* Container for the two decks */
            .dj-decks-container {
                display: flex;
                flex-direction: row; /* Decks side-by-side */
                flex-wrap: wrap;
                order: 2; /* Decks after library */
                width: 100%;
                gap: 5px;
            }
            .deck-container {
                /* Decks take 50% width each */
                flex-basis: calc(50% - 2.5px); 
                flex-grow: 1;
                min-width: 170px; 
                height: auto; 
                min-height: 0;
            }

            .deck-sliders {
                flex-direction: row; /* Sliders side-by-side */
                justify-content: space-around; 
                flex-grow: 0;
                padding: 10px 0;
            }
            
            .volume-slider, .bpm-slider {
                height: 120px; /* Shorter vertical sliders */
            }
            
            .scrub-platter {
                width: 25px; 
                height: 25px;
            }
            .platter-spindle {
                width: 4px;
                height: 4px;
            }
            .track-name-display {
                gap: 5px; 
            }
            
            /* Playlist window mobile */
            #playlist-window .content {
                flex-direction: column;
            }
            #playlist-list-container {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #808080;
                padding-right: 0;
                padding-bottom: 10px;
                height: 200px; /* Fixed height for list */
            }
            #playlist-tracks-container {
                padding-left: 0;
                height: 250px; /* Fixed height for tracks */
            }

            /* Stack bottom bar items */
            #color-picker-container {
                position: fixed; 
                bottom: 0;
                left: 0;
                width: 100%;
                flex-wrap: wrap; 
                justify-content: center;
                z-index: 1001; 
                border-top: 2px solid #fff;
                border-right: none;
                border-left: none; 
            }
            #digital-clock {
                position: fixed;
                bottom: 45px; 
                left: 0;
                width: 100%;
                text-align: center;
                z-index: 1000;
                border-bottom: 2px solid #404040;
                border-top: 2px solid #fff;
                border-left: none;
                border-right: none;
                padding: 8px 10px; 
            }
        }
        
        /* Narrower phones */
        @media (max-width: 380px) {
             #file-list, #mix-list {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
                gap: 10px;
            }
            /* Stack EQ knobs */
            .eq-controls {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            .eq-slider {
                width: 70%;
                max-width: 200px;
            }
            /* Stack Load button and BPM display */
            .load-info-container {
                flex-direction: column;
                align-items: stretch; 
            }
            .current-bpm-display {
                min-width: 0; 
            }
            .deck-controls .window-button {
                width: 38px; /* Smaller buttons */
                font-size: 10px;
            }
        }

    </style>
</head>
<body>

    <!-- Main Player Window -->
    <div class="player-container window" id="player-container">
        <div class="title-bar">
            <span class="title-bar-text">🎵 Ilan Reiss Music Player</span>
            <div class="title-bar-buttons">
                <button class="window-button" id="minimize-player-button">_</button>
                <button class="window-button close-button" data-target="player-container">X</button>
            </div>
        </div>
        
        <div class="content">
            <div class="player-controls">
                <span id="now-playing">Select a track to play</span>
                <!-- Standard HTML audio element -->
                <audio id="audio-player" controls crossorigin="anonymous"></audio>
            </div>
            
            <div class="content-inner">
                <div class="search-sort-container">
                    <input type="text" id="search-bar" placeholder="Search tracks...">
                    <button id="sort-az" class="window-button sort-button">A-Z</button>
                    <button id="sort-za" class="window-button sort-button">Z-A</button>
                    <button id="bitcrush-toggle" class="window-button sort-button" title="Toggle 12-Bit Audio">12-Bit</button>
                </div>

                <div class="file-browser" id="file-browser-main">
                    <!-- Tab Navigation -->
                    <div id="player-tabs" class="title-bar-buttons" style="margin-bottom: 5px; border-bottom: 2px solid #808080; padding-bottom: 5px;">
                        <button class="visualizer-tab window-button active" data-tab="tracks">All Tracks</button>
                        <button class="visualizer-tab window-button" data-tab="mixes">Mixes</button>
                    </div>
                    
                    <!-- Track List -->
                    <ul id="file-list" class="tab-content active" data-tab-content="tracks">
                        <!-- Tracks populated by JS -->
                    </ul>
                    
                    <!-- Mixes List -->
                    <ul id="mix-list" class="tab-content" data-tab-content="mixes">
                        <!-- Mixes populated by JS -->
                    </ul>
                </div>
                
                 <div class="player-bottom-buttons">
                     <button id="info-button" class="window-button">i</button>
                     <button id="open-playlists-button" class="window-button" title="Open Playlists">
                         <i class="fas fa-folder"></i>
                     </button>
                     <button id="add-track-now-playing" class="window-button" title="Add Current Track to Playlist">+</button>
                 </div>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <!-- Visualizer Window -->
    <div id="visualizer-window" class="window">
         <div class="title-bar">
            <div id="visualizer-tabs">
                <button class="visualizer-tab window-button" data-visualizer="cosmicPulse">Cosmic Pulse</button>
                <button class="visualizer-tab window-button" data-visualizer="aeroEnergy">Aero Energy</button>
                <button class="visualizer-tab window-button" data-visualizer="retroWaveform">Retro Waveform</button>
            </div>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="visualizer-window">X</button>
            </div>
        </div>
        <div class="content" style="padding: 0; border: 2px inset #808080; border-top-color: #404040; border-left-color: #404040; border-right-color: #fff; border-bottom-color: #fff; background: #000;">
            <canvas id="visualizer-canvas"></canvas>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <!-- Info Window -->
    <div id="info-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">ℹ️ Ilan Reiss Music Player Info</span>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="info-window">X</button>
            </div>
        </div>
        <div class="content">
            <p>Hi, welcome to Ilan Reiss's site. Here is a collection of my tracks that I have produced over the past year. Dig to find the good ones.</p>
            <p>Version 3.5 (Mix Tab Parity)</p> <!-- Updated Version -->
            <br>
            <p>Follow me on Instagram: <a href="https://www.instagram.com/ilanreiss/" target="_blank">@ilanreiss</a></p>
            <br>
            <p><em>(You can edit this text in the index.html file)</em></p>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- Playlist Window -->
    <div id="playlist-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">📁 Playlists</span>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="playlist-window">X</button>
            </div>
        </div>
        <div class="content">
            <!-- Left panel: List of playlists -->
            <div id="playlist-list-container">
                <div id="playlist-list-header">
                    <span>My Playlists</span>
                    <div id="playlist-buttons">
                        <button class="window-button" id="new-playlist-button" title="New Playlist">+</button>
                        <button class="window-button" id="rename-playlist-button" title="Rename Selected">R</button>
                        <button class="window-button" id="delete-playlist-button" title="Delete Selected">-</button>
                    </div>
                </div>
                <ul id="playlist-list"></ul>
            </div>
            <!-- Right panel: Tracks in selected playlist -->
            <div id="playlist-tracks-container">
                <div id="playlist-tracks-header">
                    <span id="playlist-tracks-title">Tracks</span>
                </div>
                <ul id="playlist-tracks"></ul>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- DJ App Window -->
    <div id="dj-app-window" class="window">
        <div class="title-bar">
            <span class="title-bar-text">🎧 DJ Decks</span>
            <div class="title-bar-buttons">
                <button class="window-button" id="minimize-dj-button">_</button>
                <button class="window-button close-button" data-target="dj-app-window">X</button>
            </div>
        </div>
        <div class="content">
            <!-- Deck A -->
            <div class="deck-container" id="deck-a">
                <div class="track-name-display" id="deck-a-display">
                    <div class="scrub-platter" id="deck-a-platter">
                        <div class="platter-spindle"></div>
                    </div>
                    <span class="track-name-text" id="deck-a-track-name">DECK A</span>
                </div>
                <div class="load-info-container">
                    <button class="window-button load-button" id="load-deck-a">LOAD</button>
                    <span class="current-bpm-display" id="deck-a-current-bpm">-- BPM</span>
                </div>
                <input type="range" class="scrub-bar" id="deck-a-scrub" value="0" min="0" max="1000">
                <div class="deck-controls">
                    <button class="window-button" id="deck-a-play">PLAY</button>
                    <button class="window-button" id="deck-a-pause">PAUSE</button>
                    <button class="window-button" id="deck-a-cue">CUE</button>
                    <button class="window-button echo-button" id="deck-a-echo" title="Toggle Echo">ECHO</button>
                </div>
                <div class="eq-controls">
                    <div class="eq-dial">
                        <label for="deck-a-low">LOW</label>
                        <input type="range" id="deck-a-low" class="eq-slider" min="-30" max="0" value="0" step="1">
                    </div>
                    <div class="eq-dial">
                        <label for="deck-a-mid">MID</label>
                        <input type="range" id="deck-a-mid" class="eq-slider" min="-30" max="0" value="0" step="1">
                    </div>
                    <div class="eq-dial">
                        <label for="deck-a-high">HI</label>
                        <input type="range" id="deck-a-high" class="eq-slider" min="-30" max="0" value="0" step="1">
                    </div>
                    <div class="eq-dial">
                        <label for="deck-a-filter">FILTER</label>
                        <input type="range" id="deck-a-filter" class="eq-slider" min="0" max="100" value="100" step="1">
                    </div>
                </div>
                <div class="deck-sliders">
                    <div class="volume-slider-container">
                        <label for="deck-a-volume">VOL</label>
                        <input type="range" class="volume-slider" id="deck-a-volume" value="1" min="0" max="1" step="0.01">
                    </div>
                    <div class="bpm-slider-container">
                        <div class="bpm-label-group">
                            <label for="deck-a-bpm">BPM</label>
                            <span class="bpm-display" id="deck-a-bpm-display">100%</span>
                        </div>
                        <input type="range" class="bpm-slider" id="deck-a-bpm" value="1" min="0.5" max="1.5" step="0.001">
                    </div>
                </div>
                <audio id="deck-a-audio" crossorigin="anonymous"></audio>
            </div>
            
            <!-- Library -->
            <div id="dj-library-container">
                <div id="dj-library-header">
                    <button class="window-button sort-button" id="sort-bpm" style="width: 100%;">Sort by BPM</button>
                </div>
                <ul id="dj-library-list">
                    <!-- Tracks populated by JS -->
                </ul>
            </div>

            <!-- Deck B -->
            <div class="deck-container" id="deck-b">
                <div class="track-name-display" id="deck-b-display">
                    <div class="scrub-platter" id="deck-b-platter">
                        <div class="platter-spindle"></div>
                    </div>
                    <span class="track-name-text" id="deck-b-track-name">DECK B</span>
                </div>
                <div class="load-info-container">
                    <button class="window-button load-button" id="load-deck-b">LOAD</button>
                    <span class="current-bpm-display" id="deck-b-current-bpm">-- BPM</span>
                </div>
                <input type="range" class="scrub-bar" id="deck-b-scrub" value="0" min="0" max="1000">
                <div class="deck-controls">
                    <button class="window-button" id="deck-b-play">PLAY</button>
                    <button class="window-button" id="deck-b-pause">PAUSE</button>
                    <button class="window-button" id="deck-b-cue">CUE</button>
                    <button class="window-button echo-button" id="deck-b-echo" title="Toggle Echo">ECHO</button>
                </div>
                <div class="eq-controls">
                    <div class="eq-dial">
                        <label for="deck-b-low">LOW</label>
                        <input type="range" id="deck-b-low" class="eq-slider" min="-30" max="0" value="0" step="1">
                    </div>
                    <div class="eq-dial">
                        <label for="deck-b-mid">MID</label>
                        <input type="range" id="deck-b-mid" class="eq-slider" min="-30" max="0" value="0" step="1">
                    </div>
                    <div class="eq-dial">
                        <label for="deck-b-high">HI</label>
                        <input type="range" id="deck-b-high" class="eq-slider" min="-30" max="0" value="0" step="1">
                    </div>
                    <div class="eq-dial">
                        <label for="deck-b-filter">FILTER</label>
                        <input type="range" id="deck-b-filter" class="eq-slider" min="0" max="100" value="100" step="1">
                    </div>
                </div>
                <div class="deck-sliders">
                    <div class="volume-slider-container">
                        <label for="deck-b-volume">VOL</label>
                        <input type="range" class="volume-slider" id="deck-b-volume" value="1" min="0" max="1" step="0.01">
                    </div>
                    <div class="bpm-slider-container">
                        <div class="bpm-label-group">
                            <label for="deck-b-bpm">BPM</label>
                            <span class="bpm-display" id="deck-b-bpm-display">100%</span>
                        </div>
                        <input type="range" class="bpm-slider" id="deck-b-bpm" value="1" min="0.5" max="1.5" step="0.001">
                    </div>
                </div>
                <audio id="deck-b-audio" crossorigin="anonymous"></audio>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <!-- Bottom Bar: Clock -->
    <div id="digital-clock"></div>

    <!-- Bottom Bar: Color Picker & Minimized Icons -->
    <div id="color-picker-container">
        <label for="bg-color-picker">BG:</label>
        <input type="color" id="bg-color-picker" value="#008080">
        
        <div id="minimized-player-icon" title="Restore Music Player">
            <i class="fas fa-headphones"></i> 
        </div>
        <div id="open-dj-app-icon" title="Open DJ App">
            <i class="fas fa-compact-disc"></i> 
        </div>
        <div id="minimized-dj-icon" title="Restore DJ App">
            <i class="fas fa-compact-disc"></i> 
        </div>
    </div>
 
    <!-- Context Menu (hidden) -->
    <div id="track-context-menu">
        <ul>
            <li id="add-to-playlist-menu">
                Add to Playlist <i class="fas fa-chevron-right" style="float: right; font-size: 0.8em; margin-top: 4px;"></i>
                <ul id="add-to-playlist-submenu">
                    <!-- Playlists populated by JS -->
                </ul>
            </li>
        </ul>
    </div>
    
    <!-- Custom Alert Modal (hidden) -->
    <div id="custom-alert-modal" class="custom-modal-overlay">
        <div class="custom-modal-window">
            <div class="custom-modal-titlebar">Alert</div>
            <div id="custom-alert-message" class="custom-modal-message"></div>
            <div class="custom-modal-buttons">
                <button id="custom-alert-ok" class="window-button">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirm Modal (hidden) -->
    <div id="custom-confirm-modal" class="custom-modal-overlay">
        <div class="custom-modal-window">
            <div class="custom-modal-titlebar">Confirm</div>
            <div id="custom-confirm-message" class="custom-modal-message"></div>
            <div class="custom-modal-buttons">
                <button id="custom-confirm-ok" class="window-button">OK</button>
                <button id="custom-confirm-cancel" class="window-button">Cancel</button>
            </div>
        </div>
    </div>
    

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        console.log('Ilan Reiss Music Player v3.5 - Mix Tab Parity'); // Updated version
        
        // --- Custom Modal Functions (for alerts/confirms) ---
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOk = document.getElementById('custom-alert-ok');
        
        function customAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.style.display = 'flex';
            customAlertOk.onclick = () => {
                customAlertModal.style.display = 'none';
            };
        }
        
        const customConfirmModal = document.getElementById('custom-confirm-modal');
        const customConfirmMessage = document.getElementById('custom-confirm-message');
        const customConfirmOk = document.getElementById('custom-confirm-ok');
        const customConfirmCancel = document.getElementById('custom-confirm-cancel');

        function customConfirm(message) {
            return new Promise((resolve) => {
                customConfirmMessage.textContent = message;
                customConfirmModal.style.display = 'flex';
                
                customConfirmOk.onclick = () => {
                    customConfirmModal.style.display = 'none';
                    resolve(true);
                };
                customConfirmCancel.onclick = () => {
                    customConfirmModal.style.display = 'none';
                    resolve(false);
                };
            });
        }
        
        // --- Configuration & Elements ---
        
        // List of all track .mp3 files
        const audioFiles = [
            "2 part shit.mp3", "42 cent.mp3", "67.mp3", "808 beat sample.mp3",
            "a break.mp3", "all me.mp3", "another one.mp3", "asher organ.mp3",
            "ass with potench.mp3", "bad one.mp3", "been a minu.mp3", "beeps.mp3",
            "before my set.mp3", "before you go.mp3", "black airforces.mp3",
            "bubs final.mp3", "bubs.mp3", "buds.mp3", "bullshittin.mp3",
            "candy shack.mp3", "chicos.mp3", "chilled.mp3", "com 303 sh.mp3",
            "corp. rework.mp3", "corp..mp3", "cya.mp3", "cypher chopped.mp3",
            "danklin.mp3", "day ones.mp3", "day today .mp3", "delete this track.mp3",
            "dub w.mp3", "easter.mp3", "ff.mp3", "flip.mp3", "fly guy.mp3",
            "for it.mp3", "for the car.mp3", "fridays.mp3", "fuckin idk.mp3",
            "funky.mp3", "gallery lazy break.mp3", "gallery.mp3", "giving in.mp3",
            "go 2.mp3", "goin crazy wit 10 racks.mp3", "goin crazy with 10 racks.mp3",
            "golf soundscape.mp3", "gover.mp3", "grizzlies ART.mp3", "grizzlies.mp3",
            "half life beat.mp3", "hammer down.mp3", "have it.mp3", "have to save.mp3",
            "hit the cart.mp3", "House on plane.mp3", "huh.mp3", "hyper fix.mp3",
            "i wanna.mp3", "insanity.mp3", "is ass.mp3", "jungled.mp3", "kenny.mp3",
            "kirked.mp3", "last of day.mp3", "lastly.mp3", "late.mp3", "lib beat.mp3",
            "locked.mp3", "lost it unfinished.mp3", "lyra demo.mp3", "ma.mp3",
            "making progress thru.mp3", "making progress.mp3", "mini 808.mp3",
            "MPC iPhone beat.mp3", "my amigo.mp3", "my sound scape.mp3",
            "new jersey club.mp3", "new setup.mp3", "niko again .mp3",
            "niko again unfinished.mp3", "niko is talking.mp3", "not done beat.mp3",
            "not thru.mp3", "not trash.mp3", "null.mp3", "number 3 shit.mp3",
            "On plane shiz.mp3", "postd.mp3", "practice.mp3", "quiky.mp3",
            "rabbits.mp3", "read up.mp3", "recipe.mp3", "redo.mp3", "reggae.mp3",
            "reggetons.mp3", "Reiss_Soundscape_edit.mp3", "Reiss_soundscape_raw.mp3",
            "rick poppa.mp3", "rythm.mp3", "same goal.mp3", "saturday morning.mp3",
            "saturn.mp3", "save rq.mp3", "saved it.mp3", "serup.mp3",
            "shit is trash.mp3", "shortest beat.mp3", "show class.mp3",
            "show trash.mp3", "slash slowed.mp3", "slash.mp3", "slow jam 2.mp3",
            "slow ride.mp3", "snippes.mp3", "soundbath 2.0.mp3", "soundbath.mp3",
            "SP iPhone sample.mp3", "spit it out.mp3", "standing in the rain.mp3",
            "starterd.mp3", "sue nami.mp3", "surfin.mp3", "swang.mp3",
            "swing song w eli.mp3", "synth demo.mp3", "take 2.mp3", "techno.mp3",
            "that way.mp3", "the monitor.mp3", "the worst beat ever.mp3",
            "this again.mp3", "threw together.mp3", "throw it up.mp3",
            "thursday.mp3", "trios.mp3", "trump-pets.mp3", "un house.mp3",
            "w issy.mp3", "watch it go.mp3", "week from today.mp3",
            "what am i doing.mp3", "what is this.mp3", "z style.mp3"
        ];
        
        // List of all mix .mp3 files
        const mixFiles = [
            "1moremintue mix.mp3", "2am mix.mp3", "11minute mix.mp3", 
            "30 mins top chees mix.mp3", "APL Mix.mp3", "babylon mix.mp3",
            "back mix.mp3", "beauti mix.mp3", "best mix.mp3", 
            "bolden gull mix.mp3", "brudda mix.mp3", "cloud nine mix.mp3",
            "for video mix.mp3", "in da jungle mix.mp3", "like me mix.mp3",
            "mix with wires.mp3", "motr mix.mp3", "nightmare mix.mp3",
            "no ice mix.mp3", "otw mix.mp3", "party 126 mix.mp3", 
            "point of interest mix.mp3", "portland o mix.mp3", 
            "screetch alt mix mixer.mp3", "turntit mix.mp3", "undeny mix.mp3"
        ];
        
        // BPM data for all tracks
        const bpmMap = new Map([
            ["last of day.mp3", 126.07], ["surfin.mp3", 92.99], ["a break.mp3", 178.03],
            ["flip.mp3", 134.02], ["soundbath.mp3", 134.97], ["serup.mp3", 137.00],
            ["bubs.mp3", 160.03], ["not thru.mp3", 90.01], ["candy shack.mp3", 133.02],
            ["hammer down.mp3", 137.00], ["delete this track.mp3", 89.00], ["thursday.mp3", 127.02],
            ["watch it go.mp3", 112.02], ["locked.mp3", 85.00], ["synth demo.mp3", 129.15],
            ["is ass.mp3", 146.00], ["the worst beat ever.mp3", 110.22], ["have it.mp3", 137.02],
            ["golf soundscape.mp3", 148.37], ["fuckin idk.mp3", 118.02], ["niko again unfinished.mp3", 121.00],
            ["read up.mp3", 86.02], ["un house.mp3", 134.02], ["the monitor.mp3", 135.02],
            ["kirked.mp3", 84.00], ["hit the cart.mp3", 135.00], ["rythm.mp3", 92.02],
            ["lib beat.mp3", 83.00], ["making progress thru.mp3", 133.92], ["save rq.mp3", 77.50],
            ["gallery lazy break.mp3", 162.00], ["threw together.mp3", 126.02], ["take 2.mp3", 133.02],
            ["slow jam 2.mp3", 92.02], ["cya.mp3", 154.00], ["day today .mp3", 90.01],
            ["my amigo.mp3", 83.00], ["lost it unfinished.mp3", 156.02], ["corp..mp3", 135.01],
            ["been a minu.mp3", 99.02], ["show class.mp3", 154.00], ["buds.mp3", 95.02],
            ["House on plane.mp3", 132.00], ["grizzlies.mp3", 95.00], ["MPC iPhone beat.mp3", 82.97],
            ["insanity.mp3", 134.02], ["swang.mp3", 92.02], ["SP iPhone sample.mp3", 167.43],
            ["what is this.mp3", 89.00], ["On plane shiz.mp3", 164.00], ["shortest beat.mp3", 162.05],
            ["spit it out.mp3", 89.02], ["com 303 sh.mp3", 164.00], ["snippes.mp3", 91.02],
            ["corp. rework.mp3", 135.02], ["black airforces.mp3", 111.02], ["slash slowed.mp3", 105.96],
            ["new setup.mp3", 123.02], ["reggae.mp3", 145.02], ["half life beat.mp3", 76.50],
            ["huh.mp3", 144.04], ["easter.mp3", 133.02], ["what am i doing.mp3", 111.02],
            ["late.mp3", 89.00], ["goin crazy wit 10 racks.mp3", 80.00], ["for the car.mp3", 72.50],
            ["another one.mp3", 87.00], ["saturn.mp3", 135.02], ["soundbath 2.0.mp3", 142.47],
            ["dub w.mp3", 122.02], ["redo.mp3", 80.01], ["rabbits.mp3", 169.45],
            ["postd.mp3", 82.00], ["recipe.mp3", 123.00], ["week from today.mp3", 97.00],
            ["for it.mp3", 86.97], ["shit is trash.mp3", 96.02], ["niko again .mp3", 121.00],
            ["null.mp3", 133.02], ["saturday morning.mp3", 137.02], ["i wanna.mp3", 128.04],
            ["slash.mp3", 126.02], ["bubs final.mp3", 80.00], ["beeps.mp3", 81.50],
            ["not trash.mp3", 85.00], ["danklin.mp3", 135.99], ["chicos.mp3", 131.00],
            ["number 3 shit.mp3", 92.02], ["goin crazy with 10 racks.mp3", 80.00], ["all me.mp3", 84.01],
            ["new jersey club.mp3", 156.00], ["hyper fix.mp3", 137.06], ["this again.mp3", 162.02],
            ["sue nami.mp3", 152.00], ["67.mp3", 80.00], ["ma.mp3", 128.03],
            ["jungled.mp3", 172.03], ["funky.mp3", 112.02], ["lastly.mp3", 97.02],
            ["go 2.mp3", 138.47], ["gallery.mp3", 81.01], ["kenny.mp3", 126.00],
            ["before you go.mp3", 80.00], ["day ones.mp3", 89.00], ["have to save.mp3", 95.02],
            ["42 cent.mp3", 89.02], ["fly guy.mp3", 94.00], ["not done beat.mp3", 80.00],
            ["quiky.mp3", 127.02], ["throw it up.mp3", 101.00], ["fridays.mp3", 145.00],
            ["rick poppa.mp3", 117.00], ["mini 808.mp3", 134.02], ["niko is talking.mp3", 80.50],
            ["trios.mp3", 92.08], ["2 part shit.mp3", 128.56], ["chilled.mp3", 129.02],
            ["standing in the rain.mp3", 83.00], ["cypher chopped.mp3", 174.21], ["saved it.mp3", 96.02],
            ["before my set.mp3", 126.02], ["giving in.mp3", 83.00], ["that way.mp3", 95.00],
            ["slow ride.mp3", 88.00], ["same goal.mp3", 124.02], ["trump-pets.mp3", 99.05],
            ["swing song w eli.mp3", 87.01], ["lyra demo.mp3", 125.02], ["starterd.mp3", 153.00],
            ["techno.mp3", 143.05], ["my sound scape.mp3", 85.16], ["bullshittin.mp3", 100.00],
            ["Reiss_soundscape_raw.mp3", 0.00], ["gover.mp3", 121.00], ["reggetons.mp3", 103.00],
            ["grizzlies ART.mp3", 95.00], ["ff.mp3", 78.50], ["ass with potench.mp3", 123.02],
            ["808 beat sample.mp3", 134.02], ["z style.mp3", 94.00], ["Reiss_Soundscape_edit.mp3", 100.84],
            ["practice.mp3", 94.01], ["w issy.mp3", 89.01], ["show trash.mp3", 153.96],
            ["bad one.mp3", 136.02], ["asher organ.mp3", 133.00], ["making progress.mp3", 134.00]
        ]);

        // Create objects for tracks, assigning BPM or a default
        const audioFileObjects = audioFiles.map(file => ({
            name: file,
            bpm: bpmMap.get(file) || 120.00 
        }));
        
        // Create objects for mixes (no BPM)
        const mixFileObjects = mixFiles.map(file => ({
            name: file,
            bpm: 0 // BPM not applicable for mixes
        }));
        
        let currentTracklist = [...audioFileObjects]; // For main player
        let currentMixlist = [...mixFileObjects]; // For mixes tab
        let currentDjTracklist = [...audioFileObjects]; // For DJ library
        let selectedDjTrack = null; 
        let djSortAscending = true; 
        let currentMainPlayerTab = 'tracks'; // State for main player tabs

        // --- Element References ---
        // Main Player
        const audioPlayer = document.getElementById('audio-player');
        const fileListElement = document.getElementById('file-list');
        const mixListElement = document.getElementById('mix-list'); // Mixes list
        const playerTabs = document.querySelectorAll('#player-tabs .visualizer-tab'); // Player tabs
        const playerTabContents = document.querySelectorAll('.tab-content'); // Player tab content
        const nowPlayingElement = document.getElementById('now-playing');
        const searchBar = document.getElementById('search-bar');
        const sortAzButton = document.getElementById('sort-az');
        const sortZaButton = document.getElementById('sort-za');
        const bitcrushToggle = document.getElementById('bitcrush-toggle');
        
        // Windows
        const allWindows = document.querySelectorAll('.window');
        const playerContainer = document.getElementById('player-container');
        const visualizerWindow = document.getElementById('visualizer-window');
        const infoWindow = document.getElementById('info-window');
        const infoButton = document.getElementById('info-button');
        const digitalClock = document.getElementById('digital-clock');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const visualizerTabs = document.getElementById('visualizer-tabs');
        const minimizePlayerButton = document.getElementById('minimize-player-button');
        const minimizedPlayerIcon = document.getElementById('minimized-player-icon');
        
        // DJ App
        const djAppWindow = document.getElementById('dj-app-window');
        const openDjAppIcon = document.getElementById('open-dj-app-icon');
        const minimizeDjButton = document.getElementById('minimize-dj-button');
        const minimizedDjIcon = document.getElementById('minimized-dj-icon');
        const djLibraryList = document.getElementById('dj-library-list');
        const sortBpmButton = document.getElementById('sort-bpm');
        
        // Visualizer
        const canvas = document.getElementById('visualizer-canvas');
        const ctx = canvas.getContext('2d');
        
        // Playlists
        const playlistWindow = document.getElementById('playlist-window');
        const openPlaylistsButton = document.getElementById('open-playlists-button');
        const addTrackNowPlayingButton = document.getElementById('add-track-now-playing');
        const playlistList = document.getElementById('playlist-list');
        const playlistTracks = document.getElementById('playlist-tracks');
        const playlistTracksTitle = document.getElementById('playlist-tracks-title');
        const newPlaylistButton = document.getElementById('new-playlist-button');
        const renamePlaylistButton = document.getElementById('rename-playlist-button');
        const deletePlaylistButton = document.getElementById('delete-playlist-button');
        
        // Context Menu
        const contextMenu = document.getElementById('track-context-menu');
        const contextMenuPlaylistList = document.getElementById('add-to-playlist-submenu');
        
        // State variables
        let visualizerColor = '#00FFFF';
        let secondaryColor = '#FF00FF';
        let activeVisualizer = 'cosmicPulse'; 
        let playlists = [];
        let selectedPlaylistId = null;
        let contextMenuTrack = null;
        let contextMenuLongPressTimer = null;

        // --- Audio Context Setup ---
        let audioContext, analyser;
        let bitCrusherNode; 
        let isBitcrushActive = false; 
        let frequencyData, timeDomainData;
        let bufferLength;
        let visualizerActive = false;
        let animationFrameId;

        // Audio nodes for all sources
        let sourceMain = null, sourceDeckA = null, sourceDeckB = null;
        let gainA, gainB, gainMain;
        let filterALow, filterAMid, filterAHigh, filterBLow, filterBMid, filterBHigh;
        let filterAFilter, filterBFilter; // DJ Low-pass filters
        let delayA, feedbackA, wetMixA; // Deck A Echo
        let delayB, feedbackB, wetMixB; // Deck B Echo
        
        function setupAudioContext() {
            if (audioContext) return;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            analyser.smoothingTimeConstant = 0.8; 
            
            // Create sources from HTML audio elements
            sourceMain = audioContext.createMediaElementSource(audioPlayer);
            sourceDeckA = audioContext.createMediaElementSource(document.getElementById('deck-a-audio'));
            sourceDeckB = audioContext.createMediaElementSource(document.getElementById('deck-b-audio'));
            
            // Gain nodes for volume control
            gainA = audioContext.createGain();
            gainB = audioContext.createGain();
            gainMain = audioContext.createGain();
            
            // --- EQ Filters (BiquadFilter) ---
            filterALow = audioContext.createBiquadFilter();
            filterAMid = audioContext.createBiquadFilter();
            filterAHigh = audioContext.createBiquadFilter();
            filterBLow = audioContext.createBiquadFilter();
            filterBMid = audioContext.createBiquadFilter();
            filterBHigh = audioContext.createBiquadFilter();
            
            // Deck A EQ
            filterALow.type = 'lowshelf'; filterALow.frequency.value = 300; filterALow.gain.value = 0;
            filterAMid.type = 'peaking'; filterAMid.frequency.value = 1200; filterAMid.Q.value = 1.0; filterAMid.gain.value = 0;
            filterAHigh.type = 'highshelf'; filterAHigh.frequency.value = 4000; filterAHigh.gain.value = 0;
            
            // Deck B EQ
            filterBLow.type = 'lowshelf'; filterBLow.frequency.value = 300; filterBLow.gain.value = 0;
            filterBMid.type = 'peaking'; filterBMid.frequency.value = 1200; filterBMid.Q.value = 1.0; filterBMid.gain.value = 0;
            filterBHigh.type = 'highshelf'; filterBHigh.frequency.value = 4000; filterBHigh.gain.value = 0;

            // --- DJ FX: Low-pass Filters ---
            filterAFilter = audioContext.createBiquadFilter();
            filterAFilter.type = 'lowpass';
            filterAFilter.frequency.value = 20000; // Start wide open
            filterAFilter.Q.value = 1.0;
            
            filterBFilter = audioContext.createBiquadFilter();
            filterBFilter.type = 'lowpass';
            filterBFilter.frequency.value = 20000; 
            filterBFilter.Q.value = 1.0;
            
            // --- DJ FX: Echo/Delay Chain ---
            // Deck A Echo
            delayA = audioContext.createDelay(1.0); 
            feedbackA = audioContext.createGain();
            wetMixA = audioContext.createGain(); // This controls the echo volume
            delayA.delayTime.value = 0.4; 
            feedbackA.gain.value = 0.4; // Feedback amount
            wetMixA.gain.value = 0.0; // Start off (dry)
            
            // Deck B Echo
            delayB = audioContext.createDelay(1.0);
            feedbackB = audioContext.createGain();
            wetMixB = audioContext.createGain();
            delayB.delayTime.value = 0.4;
            feedbackB.gain.value = 0.4;
            wetMixB.gain.value = 0.0; // Start off (dry)
            
            // --- Connect Deck A (EQ -> Filter -> Split for Echo) ---
            sourceDeckA.connect(filterALow);
            filterALow.connect(filterAMid);
            filterAMid.connect(filterAHigh);
            filterAHigh.connect(filterAFilter); // EQ goes into Filter
            
            // DRY Path: Filter -> Gain -> Analyser
            filterAFilter.connect(gainA);      
            gainA.connect(analyser);
            
            // WET (Echo) Path: Filter -> Delay -> Feedback Loop -> Wet Mix -> Analyser
            filterAFilter.connect(delayA); 
            delayA.connect(feedbackA);         
            feedbackA.connect(delayA); // Feedback loop
            delayA.connect(wetMixA);           
            wetMixA.connect(analyser); // Echo signal goes to analyser
            
            // --- Connect Deck B (EQ -> Filter -> Split for Echo) ---
            sourceDeckB.connect(filterBLow);
            filterBLow.connect(filterBMid);
            filterBMid.connect(filterBHigh);
            filterBHigh.connect(filterBFilter);
            
            // DRY Path
            filterBFilter.connect(gainB);       
            gainB.connect(analyser);
            
            // WET (Echo) Path
            filterBFilter.connect(delayB);
            delayB.connect(feedbackB);
            feedbackB.connect(delayB);
            delayB.connect(wetMixB);
            wetMixB.connect(analyser);

            // --- Bitcrusher setup ---
            bitCrusherNode = audioContext.createWaveShaper();
            const steps = Math.pow(2, 8);
            const curve = new Float32Array(65536);
            for (let i = 0; i < curve.length; i++) {
                const inputSample = (i / (curve.length - 1)) * 2 - 1;
                curve[i] = Math.round(inputSample * (steps / 2)) / (steps / 2);
            }
            bitCrusherNode.curve = curve;
            
            // Analyser connects to destination (speakers)
            analyser.connect(audioContext.destination);
            
            // Setup data arrays for visualizer
            bufferLength = analyser.frequencyBinCount;
            frequencyData = new Uint8Array(bufferLength);
            timeDomainData = new Uint8Array(bufferLength);

            // --- Connect Main Player ---
            sourceMain.connect(gainMain); 
            // The bitcrusher logic will handle connecting gainMain to the right place
            toggleBitcrusher(true); // Run once on setup to establish connection
        }

        // Toggle bitcrusher on/off
        function toggleBitcrusher(forceReconnect = false) {
            if (!analyser) return; 
            
            if (!forceReconnect) {
                isBitcrushActive = !isBitcrushActive;
            }

            // Disconnect main player's gain node
            try { gainMain.disconnect(); } catch(e) {}
            
            if (isBitcrushActive) {
                // Route: Main Gain -> Bitcrusher -> Analyser
                gainMain.connect(bitCrusherNode);
                bitCrusherNode.connect(analyser);
                bitcrushToggle.classList.add('active');
            } else {
                // Route: Main Gain -> Analyser
                try { bitCrusherNode.disconnect(analyser); } catch(e) {}
                gainMain.connect(analyser);
                bitcrushToggle.classList.remove('active');
            }
        }

        // --- Visualizer Logic ---
        function startVisualizer() {
            if (visualizerActive && animationFrameId) {
                cancelAnimationFrame(animationFrameId); 
            }
            if (audioContext) audioContext.resume(); // Resume context if suspended
            visualizerActive = true;
            visualizerWindow.style.display = 'flex';
            drawVisualizer();
        }

        function stopVisualizer() {
            visualizerActive = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }

        // Pause visualizer if tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopVisualizer();
            } else {
                const anyAudioPlaying = !audioPlayer.paused || 
                                      (document.getElementById('deck-a-audio') && !document.getElementById('deck-a-audio').paused) ||
                                      (document.getElementById('deck-b-audio') && !document.getElementById('deck-b-audio').paused);
                if (anyAudioPlaying) {
                    startVisualizer();
                }
            }
        });


        // Main visualizer animation loop
        function drawVisualizer() {
            if (!visualizerActive) {
                return;
            }

            animationFrameId = requestAnimationFrame(drawVisualizer);
            
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            // Get audio data
            analyser.getByteFrequencyData(frequencyData);
            analyser.getByteTimeDomainData(timeDomainData);
            
            // Calculate average frequency levels
            let bass = 0, mids = 0, highs = 0;
            const bassRange = [0, Math.floor(bufferLength * 0.05)]; 
            const midRange = [Math.floor(bufferLength * 0.05), Math.floor(bufferLength * 0.2)]; 
            const highRange = [Math.floor(bufferLength * 0.2), Math.floor(bufferLength * 0.4)]; 

            for (let i = bassRange[0]; i < bassRange[1]; i++) bass += frequencyData[i];
            for (let i = midRange[0]; i < midRange[1]; i++) mids += frequencyData[i];
            for (let i = highRange[0]; i < highRange[1]; i++) highs += frequencyData[i];

            let bassAvg = (bass / (bassRange[1] - bassRange[0]) || 0) / 255; 
            let midsAvg = (mids / (midRange[1] - midRange[0]) || 0) / 255; 
            let highsAvg = (highs / (highRange[1] - highRange[0]) || 0) / 255; 

            // Call the active visualizer function
            switch (activeVisualizer) {
                case 'cosmicPulse': 
                    drawCosmicPulseVisualizer(bassAvg, midsAvg, highsAvg);
                    break;
                case 'aeroEnergy':
                    drawAeroEnergyVisualizer(bassAvg, midsAvg, highsAvg);
                    break;
                case 'retroWaveform':
                    drawRetroWaveformVisualizer(timeDomainData);
                    break;
            }
        }
        
        // --- Visualizer Implementations ---
        
        // 1. Cosmic Pulse (Particles)
        const particles = [];
        const maxParticles = 300; 
        class CosmicParticle {
            constructor(centerX, centerY) {
                this.reset(centerX, centerY);
            }
            
            reset(centerX, centerY) {
                this.x = centerX || canvas.width / 2;
                this.y = centerY || canvas.height / 2;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = Math.random() * 2 + 0.5; // Base speed
                this.life = 1;
                this.size = Math.random() * 2 + 1;
                this.hue = 0;
            }

            update(bass, mids, highs) {
                const currentSpeed = this.speed * (1 + bass * 5); // Speed reacts to bass
                this.x += Math.cos(this.angle) * currentSpeed;
                this.y += Math.sin(this.angle) * currentSpeed;
                this.life -= 0.01 + (mids * 0.01); // Fade out
                this.size = (Math.random() * 2 + 1) * (1 + bass * 2); // Size reacts to bass
                this.hue = (hslToHex(visualizerColor).h + (this.x / canvas.width) * 180) % 360;

                // Reset particle if it fades or if bass hits hard
                if (this.life <= 0 || (bass > 0.6 && Math.random() > 0.9)) {
                    this.reset();
                }
            }
            
            draw(ctx) {
                ctx.fillStyle = `hsla(${this.hue}, 100%, ${60 + (this.life * 40)}%, ${this.life * 0.8})`;
                ctx.shadowColor = `hsl(${this.hue}, 100%, 70%)`;
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(this.x, this.y, Math.max(0.5, this.size), 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawCosmicPulseVisualizer(bassAvg, midsAvg, highsAvg) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; // Fade background
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.shadowBlur = 0; 

            while (particles.length < maxParticles) {
                particles.push(new CosmicParticle());
            }

            particles.forEach(p => {
                p.update(bassAvg, midsAvg, highsAvg);
                p.draw(ctx);
            });
        }

        // 2. Aero Energy (Lines)
        const aeroLines = [];
        const maxAeroLines = 35; 
        class AeroLine {
            constructor(x, y, color1, color2) {
                this.x = x; this.y = y;
                this.points = [{x: x, y: y}];
                this.length = 10 + Math.random() * 50;
                this.speed = 1 + Math.random() * 3;
                this.angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.life = 1; this.color1 = color1; this.color2 = color2; this.age = 0;
            }
            update(bass, mids, highs) {
                this.x += this.vx; this.y += this.vy;
                this.vx += (Math.random() - 0.5) * highs * 0.5;
                this.vy += (Math.random() - 0.5) * highs * 0.5;
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                this.points.unshift({x: this.x, y: this.y});
                if (this.points.length > this.length) this.points.pop();
                this.life -= 0.005 - (mids) * 0.002;
                if (this.life <= 0) this.life = 0;
                this.age++;
            }
            draw(ctx) {
                if (this.points.length < 2) return;
                ctx.globalAlpha = this.life;
                ctx.lineWidth = 2 + (this.age / 400);
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                const gradient = ctx.createLinearGradient(this.points[0].x, this.points[0].y, this.points[this.points.length - 1].x, this.points[this.points.length - 1].y);
                gradient.addColorStop(0, this.color1);
                gradient.addColorStop(1, this.color2);
                ctx.strokeStyle = gradient;
                ctx.shadowColor = this.color1;
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.moveTo(this.points[0].x, this.points[0].y);
                for (let i = 1; i < this.points.length; i++) ctx.lineTo(this.points[i].x, this.points[i].y);
                ctx.stroke();
                ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
            }
        }
        function drawAeroEnergyVisualizer(bassAvg, midsAvg, highsAvg) {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; // Fade background
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (aeroLines.length < maxAeroLines && Math.random() < 0.05 + (midsAvg) * 0.1) {
                const startX = Math.random() * canvas.width;
                const startY = Math.random() * canvas.height;
                const hueShift = (Date.now() * 0.01) % 360;
                const dynamicSecondaryColor = `hsl(${(hslToHex(visualizerColor).h + hueShift) % 360}, 100%, 65%)`;
                aeroLines.push(new AeroLine(startX, startY, visualizerColor, dynamicSecondaryColor));
            }
            for (let i = aeroLines.length - 1; i >= 0; i--) {
                aeroLines[i].update(bassAvg, midsAvg, highsAvg);
                aeroLines[i].draw(ctx);
                if (aeroLines[i].life <= 0 || aeroLines[i].age > 1000) aeroLines.splice(i, 1);
            }
        }

        // 3. Retro Waveform
        function drawRetroWaveformVisualizer(timeDomainData) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 3; ctx.strokeStyle = visualizerColor;
            ctx.shadowColor = visualizerColor; ctx.shadowBlur = 10;
            ctx.beginPath();
            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const v = timeDomainData[i] / 128.0; // 0-255 -> 0-2
                const y = v * canvas.height / 2; // 0-2 -> 0-canvas.height
                if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
            
            // Faux reflection
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, visualizerColor);
            gradient.addColorStop(0.5, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, visualizerColor);
            ctx.fillStyle = gradient; ctx.globalAlpha = 0.2;
            ctx.beginPath(); x = 0;
            ctx.moveTo(0, canvas.height);
            for(let i = 0; i < bufferLength; i++) {
                const v = timeDomainData[i] / 128.0;
                const y = v * canvas.height / 2;
                ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height);
            ctx.closePath(); ctx.fill();
            ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
        }

        // --- Window Management (Drag, Resize, Focus) ---

        let activeWindow = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffsetX, dragOffsetY;
        let resizeStartX, resizeStartY;
        let initialWidth, initialHeight;
        
        // Check if on a mobile device (based on media query)
        const isMobile = window.matchMedia("(max-width: 768px)").matches;

        // Bring window to front on click/touch
        allWindows.forEach(windowEl => {
            windowEl.addEventListener('mousedown', () => bringWindowToFront(windowEl));
            windowEl.addEventListener('touchstart', () => bringWindowToFront(windowEl), { passive: true });
        });

        function bringWindowToFront(windowEl) {
            if (isMobile) return; // No window focusing on mobile
            allWindows.forEach(win => {
                win.classList.remove('active-window');
            });
            windowEl.classList.add('active-window');
        }

        // Start dragging
        function handleDragStart(e, windowEl) {
            if (isMobile) return; 
            // Don't drag if clicking a button or interactive element
            if (e.target.classList.contains('window-button') || e.target.classList.contains('visualizer-tab') || e.target.closest('input, button, ul, canvas, .eq-slider, .volume-slider, .bpm-slider, .scrub-bar, .scrub-platter')) return;
            isDragging = true;
            activeWindow = windowEl;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragOffsetX = clientX - windowEl.offsetLeft;
            dragOffsetY = clientY - windowEl.offsetTop;
            document.body.style.cursor = 'move';
            if (e.cancelable) e.preventDefault();
        }

        // Move window
        function handleDragMove(e) {
            if (isMobile || !isDragging || !activeWindow) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let newX = clientX - dragOffsetX;
            let newY = clientY - dragOffsetY;
            // Constrain to viewport
            newX = Math.max(0, Math.min(newX, window.innerWidth - activeWindow.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - activeWindow.offsetHeight));
            activeWindow.style.left = newX + 'px';
            activeWindow.style.top = newY + 'px';
        }

        // Start resizing
        function handleResizeStart(e, windowEl) {
            if (isMobile) return; 
            isResizing = true;
            activeWindow = windowEl;
            resizeStartX = e.touches ? e.touches[0].clientX : e.clientX;
            resizeStartY = e.touches ? e.touches[0].clientY : e.clientY;
            initialWidth = windowEl.offsetWidth;
            initialHeight = windowEl.offsetHeight;
            document.body.style.cursor = 'nwse-resize';
            if (e.cancelable) e.preventDefault();
        }

        // Resize window
        function handleResizeMove(e) {
            if (isMobile || !isResizing || !activeWindow) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let newWidth = initialWidth + (clientX - resizeStartX);
            let newHeight = initialHeight + (clientY - resizeStartY);
            // Constrain to min-width/height
            const style = window.getComputedStyle(activeWindow);
            const minW = parseFloat(style.minWidth) || 250;
            const minH = parseFloat(style.minHeight) || 150;
            newWidth = Math.max(minW, newWidth);
            newHeight = Math.max(minH, newHeight);
            activeWindow.style.width = newWidth + 'px';
            activeWindow.style.height = newHeight + 'px';
        }

        // End drag/resize
        function handleEnd() {
            if (isMobile) return;
            isDragging = false;
            isResizing = false;
            activeWindow = null;
            document.body.style.cursor = 'default';
        }
        
        // Set initial window positions on desktop
        if (!isMobile) {
            playerContainer.style.left = (window.innerWidth - playerContainer.offsetWidth) / 2 + 'px';
            playerContainer.style.top = (window.innerHeight - playerContainer.offsetHeight) / 2 + 'px';
            djAppWindow.style.left = (window.innerWidth - 900) / 2 + 'px'; 
            djAppWindow.style.top = (window.innerHeight - 550) / 2 + 'px'; 
            visualizerWindow.style.left = '20px';
            visualizerWindow.style.top = '20px';
            infoWindow.style.left = '100px';
            infoWindow.style.top = '150px';
            playlistWindow.style.left = '50px';
            playlistWindow.style.top = '50px';
            bringWindowToFront(playerContainer);
        }

        // Attach drag/resize listeners
        allWindows.forEach(windowEl => {
            const titleBar = windowEl.querySelector('.title-bar');
            const resizeHandle = windowEl.querySelector('.resize-handle');
            if(titleBar && !isMobile) { 
                titleBar.addEventListener('mousedown', (e) => handleDragStart(e, windowEl));
                titleBar.addEventListener('touchstart', (e) => handleDragStart(e, windowEl), { passive: false });
            }
            if (resizeHandle && !isMobile) { 
                resizeHandle.addEventListener('mousedown', (e) => handleResizeStart(e, windowEl));
                resizeHandle.addEventListener('touchstart', (e) => handleResizeStart(e, windowEl), { passive: false });
            }
        });

        if (!isMobile) { 
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('mousemove', handleResizeMove);
            document.addEventListener('touchmove', handleResizeMove, { passive: false });
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchend', handleEnd);
        }

        // --- Main Player: Populate Lists & Tabs ---
        
        // Function to create a list item for tracks/mixes
        function createPlayerListItem(fileObj, isMix) {
            const li = document.createElement('li');
            li.innerHTML = `
                <i class="fas ${isMix ? 'fa-record-vinyl' : 'fa-music'} file-icon"></i>
                <span class="file-name">${fileObj.name.replace('.mp3', '')}</span>
            `;
            li.dataset.filename = fileObj.name;
            li.dataset.isMix = isMix; // Store type
            
            // Add click listener to play
            li.addEventListener('click', () => {
                const filename = li.dataset.filename;
                const path = li.dataset.isMix === 'true' ? 'mixes/' : 'Audio/';
                audioPlayer.src = path + filename;
                
                if (!audioContext) setupAudioContext(); 
                
                audioPlayer.play();
                nowPlayingElement.textContent = li.querySelector('.file-name').textContent;
                
                // Set active style
                document.querySelectorAll('#file-list li, #mix-list li').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
                
                updateMediaSession(filename.replace('.mp3', ''), isMix); // Update lock screen
            });

            // Context menu listeners (only for tracks, not mixes)
            if (!isMix) {
                li.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, fileObj.name);
                });
                li.addEventListener('touchstart', (e) => {
                    contextMenuLongPressTimer = setTimeout(() => {
                        e.preventDefault();
                        showContextMenu(e, fileObj.name);
                    }, 500); // 500ms long press
                }, { passive: true });
                li.addEventListener('touchend', () => {
                    clearTimeout(contextMenuLongPressTimer);
                });
            }
            return li;
        }

        // Populate "All Tracks" list
        function populateFileList(files) {
            fileListElement.innerHTML = ''; 
            files.forEach(fileObj => {
                fileListElement.appendChild(createPlayerListItem(fileObj, false));
            });
        }
        populateFileList(currentTracklist); // Initial population

        // Populate "Mixes" list
        function populateMixList(files) {
            mixListElement.innerHTML = '';
            files.forEach(fileObj => {
                mixListElement.appendChild(createPlayerListItem(fileObj, true));
            });
        }
        populateMixList(currentMixlist); // Initial population
        
        // Handle switching between "Tracks" and "Mixes" tabs
        playerTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                playerTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                currentMainPlayerTab = tab.dataset.tab;
                
                playerTabContents.forEach(content => {
                    if (content.dataset.tabContent === currentMainPlayerTab) {
                        content.style.display = 'grid'; // Both are grids
                        content.classList.add('active');
                    } else {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    }
                });
                
                // Show/hide search/sort based on tab
                const searchSort = document.querySelector('.search-sort-container');
                searchSort.style.display = 'flex'; // Show for both
            });
        });

        // --- Main Player: Search & Sort ---
        sortAzButton.addEventListener('click', () => {
            if (currentMainPlayerTab === 'tracks') {
                currentTracklist.sort((a, b) => a.name.localeCompare(b.name));
                populateFileList(currentTracklist);
            } else {
                currentMixlist.sort((a, b) => a.name.localeCompare(b.name));
                populateMixList(currentMixlist);
            }
        });

        sortZaButton.addEventListener('click', () => {
            if (currentMainPlayerTab === 'tracks') {
                currentTracklist.sort((a, b) => b.name.localeCompare(a.name));
                populateFileList(currentTracklist);
            } else {
                currentMixlist.sort((a, b) => b.name.localeCompare(a.name));
                populateMixList(currentMixlist);
            }
        });
        
        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (currentMainPlayerTab === 'tracks') {
                const filteredList = currentTracklist.filter(fileObj => 
                    fileObj.name.toLowerCase().replace('.mp3', '').includes(searchTerm)
                );
                populateFileList(filteredList);
            } else {
                const filteredList = currentMixlist.filter(fileObj => 
                    fileObj.name.toLowerCase().replace('.mp3', '').includes(searchTerm)
                );
                populateMixList(filteredList);
            }
        });

        // --- DJ App: Library & Deck Setup ---
        function populateDjLibrary(files) {
            djLibraryList.innerHTML = '';
            files.forEach(fileObj => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="dj-track-name">${fileObj.name.replace('.mp3', '')}</span>
                    <input type="number" class="dj-track-bpm" value="${fileObj.bpm.toFixed(0)}" data-filename="${fileObj.name}">
                `;
                
                // Select track on click
                li.addEventListener('click', (e) => {
                    if (e.target.tagName === 'INPUT') return; 
                    const current = djLibraryList.querySelector('.selected');
                    if (current) current.classList.remove('selected');
                    li.classList.add('selected');
                    selectedDjTrack = fileObj.name;
                });
                
                // Allow manual BPM editing
                const bpmInput = li.querySelector('.dj-track-bpm');
                bpmInput.addEventListener('input', (e) => {
                    const newBpm = parseInt(e.target.value, 10);
                    if (!isNaN(newBpm)) {
                        const trackToUpdate = currentDjTracklist.find(f => f.name === fileObj.name);
                        if (trackToUpdate) {
                            trackToUpdate.bpm = newBpm;
                        }
                    }
                });
                
                djLibraryList.appendChild(li);
            });
        }
        populateDjLibrary(currentDjTracklist); 
        
        // Sort DJ library by BPM
        sortBpmButton.addEventListener('click', () => {
            if (djSortAscending) {
                currentDjTracklist.sort((a, b) => a.bpm - b.bpm);
                sortBpmButton.textContent = "Sort BPM (Hi-Lo)";
            } else {
                currentDjTracklist.sort((a, b) => b.bpm - a.bpm);
                sortBpmButton.textContent = "Sort BPM (Lo-Hi)";
            }
            djSortAscending = !djSortAscending;
            populateDjLibrary(currentDjTracklist);
        });

        // Function to set up all controls for a single deck
        function setupDeck(deckId) {
            // Get all elements for this deck
            const audio = document.getElementById(`${deckId}-audio`);
            const trackNameText = document.getElementById(`${deckId}-track-name`);
            const platter = document.getElementById(`${deckId}-platter`);
            const bpmSlider = document.getElementById(`${deckId}-bpm`);
            const bpmDisplay = document.getElementById(`${deckId}-bpm-display`); 
            const currentBpmDisplay = document.getElementById(`${deckId}-current-bpm`); 
            
            const lowSlider = document.getElementById(`${deckId}-low`);
            const midSlider = document.getElementById(`${deckId}-mid`);
            const highSlider = document.getElementById(`${deckId}-high`);
            const filterSlider = document.getElementById(`${deckId}-filter`); 
            const echoButton = document.getElementById(`${deckId}-echo`); 
            
            const loadBtn = document.getElementById(`load-${deckId}`);
            const playBtn = document.getElementById(`${deckId}-play`);
            const pauseBtn = document.getElementById(`${deckId}-pause`);
            const cueBtn = document.getElementById(`${deckId}-cue`);
            const scrubBar = document.getElementById(`${deckId}-scrub`);
            const volumeSlider = document.getElementById(`${deckId}-volume`);

            // State for this deck
            let deckNodes; 
            let isScrubbing = false; 
            let isScrubbingPlatter = false; 
            let lastScrubX = 0;
            let baseBpm = null; 

            // LOAD button
            loadBtn.addEventListener('click', () => {
                if (selectedDjTrack) {
                    if (!audioContext) setupAudioContext(); 
                    
                    // Assign the correct audio nodes for this deck
                    deckNodes = (deckId === 'deck-a') ? {
                        gain: gainA, filters: { low: filterALow, mid: filterAMid, high: filterAHigh },
                        filter: filterAFilter, echo: { wet: wetMixA }
                    } : {
                        gain: gainB, filters: { low: filterBLow, mid: filterBMid, high: filterBHigh },
                        filter: filterBFilter, echo: { wet: wetMixB }
                    };
                    
                    audio.src = 'Audio/' + selectedDjTrack; // Load from 'Audio' folder
                    trackNameText.textContent = selectedDjTrack.replace('.mp3', ''); 
                    audio.load();
                    
                    // Set base BPM
                    const trackData = audioFileObjects.find(f => f.name === selectedDjTrack);
                    if (trackData) {
                        baseBpm = trackData.bpm;
                        currentBpmDisplay.textContent = baseBpm.toFixed(0) + ' BPM';
                    } else {
                        baseBpm = null;
                        currentBpmDisplay.textContent = '-- BPM';
                    }
                    
                    // Reset all controls
                    bpmSlider.value = 1; bpmDisplay.textContent = '100%'; 
                    audio.playbackRate = 1;
                    platter.style.transform = 'rotate(0deg)';
                    platter.style.animationPlayState = 'paused';
                    
                    lowSlider.value = 0; midSlider.value = 0; highSlider.value = 0;
                    filterSlider.value = 100;
                    echoButton.classList.remove('active'); 
                    
                    // Reset audio node values
                    if(deckNodes) {
                        deckNodes.filters.low.gain.value = 0; 
                        deckNodes.filters.mid.gain.value = 0; 
                        deckNodes.filters.high.gain.value = 0;
                        deckNodes.filter.frequency.value = 20000; 
                        deckNodes.echo.wet.gain.value = 0.0; 
                        deckNodes.gain.gain.value = 1; // Full volume
                        volumeSlider.value = 1;
                    }
                }
            });

            // PLAY button
            playBtn.addEventListener('click', () => {
                 if (!audioContext) setupAudioContext(); 
                 
                 // Ensure nodes are assigned (if not loaded first)
                 if (!deckNodes) { 
                     deckNodes = (deckId === 'deck-a') ? {
                        gain: gainA, filters: { low: filterALow, mid: filterAMid, high: filterAHigh },
                        filter: filterAFilter, echo: { wet: wetMixA }
                    } : {
                        gain: gainB, filters: { low: filterBLow, mid: filterBMid, high: filterBHigh },
                        filter: filterBFilter, echo: { wet: wetMixB }
                    };
                 }
                 
                 startVisualizer(); // Start visualizer on play
                 audio.play();
                 platter.style.animationPlayState = 'running'; // Spin platter
            });
            // PAUSE button
            pauseBtn.addEventListener('click', () => {
                audio.pause();
                platter.style.animationPlayState = 'paused'; // Stop platter
            });
            
            // CUE button (reset to 0 and pause)
            cueBtn.addEventListener('click', () => {
                audio.currentTime = 0;
                audio.pause();
                platter.style.transform = 'rotate(0deg)';
                platter.style.animationPlayState = 'paused';
                bpmSlider.value = 1;
                bpmDisplay.textContent = '100%'; 
                audio.playbackRate = 1;
                
                if (baseBpm) currentBpmDisplay.textContent = baseBpm.toFixed(0) + ' BPM';
                
                // Reset all FX
                lowSlider.value = 0; midSlider.value = 0; highSlider.value = 0;
                filterSlider.value = 100;
                echoButton.classList.remove('active'); 
                
                if(deckNodes) {
                    deckNodes.filters.low.gain.value = 0; 
                    deckNodes.filters.mid.gain.value = 0; 
                    deckNodes.filters.high.gain.value = 0;
                    deckNodes.filter.frequency.value = 20000; 
                    deckNodes.echo.wet.gain.value = 0.0; 
                    deckNodes.gain.gain.value = 1;
                    volumeSlider.value = 1;
                }
            });

            // Volume slider
            volumeSlider.addEventListener('input', () => {
                if (deckNodes) deckNodes.gain.gain.value = volumeSlider.value;
            });
            
            // BPM slider
            bpmSlider.addEventListener('input', () => {
                const rate = parseFloat(bpmSlider.value);
                audio.playbackRate = rate;
                bpmDisplay.textContent = (rate * 100).toFixed(0) + '%'; 
                
                if (baseBpm) {
                    const newBpm = baseBpm * rate;
                    currentBpmDisplay.textContent = newBpm.toFixed(1) + ' BPM';
                }
            });
            
            // EQ sliders
            lowSlider.addEventListener('input', () => {
                if(deckNodes) deckNodes.filters.low.gain.value = lowSlider.value;
            });
            midSlider.addEventListener('input', () => {
                if(deckNodes) deckNodes.filters.mid.gain.value = midSlider.value;
            });
            highSlider.addEventListener('input', () => {
                if(deckNodes) deckNodes.filters.high.gain.value = highSlider.value;
            });
            
            // Filter slider
            filterSlider.addEventListener('input', () => {
                if(deckNodes) {
                    // Convert linear 0-100 to logarithmic freq (200Hz to 20000Hz)
                    const minv = Math.log(200);
                    const maxv = Math.log(20000);
                    const scale = (maxv - minv) / 100;
                    const freq = Math.exp(minv + scale * filterSlider.value);
                    deckNodes.filter.frequency.value = freq;
                }
            });
            
            // Echo button
            echoButton.addEventListener('click', () => {
                if (deckNodes) {
                    const isActive = echoButton.classList.toggle('active');
                    deckNodes.echo.wet.gain.value = isActive ? 0.4 : 0.0; // Toggle echo on/off
                }
            });

            // Update scrub bar as song plays
            audio.addEventListener('timeupdate', () => {
                if (!isScrubbing && !isScrubbingPlatter && audio.duration) {
                    scrubBar.value = (audio.currentTime / audio.duration) * 1000;
                }
            });
            
            // Reset platter on song end
            audio.addEventListener('ended', () => {
                platter.style.animationPlayState = 'paused';
                platter.style.transform = 'rotate(0deg)';
            });
            
            // --- Scrub Bar Logic ---
            const handleScrub = () => {
                if (audio.duration) {
                    audio.currentTime = (scrubBar.value / 1000) * audio.duration;
                }
            };
            scrubBar.addEventListener('mousedown', () => isScrubbing = true);
            scrubBar.addEventListener('touchstart', () => isScrubbing = true, { passive: true });
            scrubBar.addEventListener('input', handleScrub);
            scrubBar.addEventListener('mouseup', () => isScrubbing = false);
            scrubBar.addEventListener('touchend', () => isScrubbing = false);
            
            // --- Platter Scrubbing Logic ---
            function platterStart(e) {
                if (!audio.duration) return;
                isScrubbingPlatter = true;
                lastScrubX = e.touches ? e.touches[0].clientX : e.clientX;
                platter.style.cursor = 'grabbing';
                if (!isMobile) document.body.style.cursor = 'grabbing';
                audio.pause();
                platter.style.animationPlayState = 'paused';
                
                // Add global listeners to track drag anywhere on screen
                document.addEventListener('mousemove', platterMove);
                document.addEventListener('touchmove', platterMove, { passive: false });
                document.addEventListener('mouseup', platterEnd);
                document.addEventListener('touchend', platterEnd);
                
                if (e.cancelable) e.preventDefault();
            }
            
            function platterMove(e) {
                if (!isScrubbingPlatter) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const deltaX = clientX - lastScrubX;
                lastScrubX = clientX;
                
                // Scrub audio time based on drag distance
                const scrubAmount = (deltaX / 300) * 5; // Sensitivity
                let newTime = audio.currentTime + scrubAmount;
                newTime = Math.max(0, Math.min(newTime, audio.duration));
                audio.currentTime = newTime;
                
                // Manually rotate platter
                const currentRotation = parseFloat(platter.style.transform.replace('rotate(', '').replace('deg)', '')) || 0;
                const newRotation = currentRotation + deltaX * 2.0; 
                platter.style.transform = `rotate(${newRotation}deg)`;
                
                if (e.cancelable) e.preventDefault();
            }
            
            function platterEnd() {
                if (!isScrubbingPlatter) return;
                isScrubbingPlatter = false;
                platter.style.cursor = 'grab';
                if (!isMobile) document.body.style.cursor = 'default';
                
                // Remove global listeners
                document.removeEventListener('mousemove', platterMove);
                document.removeEventListener('touchmove', platterMove);
                document.removeEventListener('mouseup', platterEnd);
                document.removeEventListener('touchend', platterEnd);
            }
            
            platter.addEventListener('mousedown', platterStart);
            platter.addEventListener('touchstart', platterStart, { passive: false });
        }
        
        setupDeck('deck-a');
        setupDeck('deck-b');
        
        // --- Main Player Event Listeners ---
        
        // Bitcrusher toggle
        bitcrushToggle.addEventListener('click', () => {
            if (!audioContext) setupAudioContext();
            toggleBitcrusher();
        });

        // Audio player event listeners for visualizer and media session
        audioPlayer.addEventListener('pause', () => { 
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'paused';
            }
        });
        audioPlayer.addEventListener('play', () => {
            if (audioContext) {
                audioContext.resume();
                startVisualizer();
            }
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'playing';
            }
        });

        
        // --- Lock Screen Controls Logic (Media Session API) ---
        
        // Find the next/previous track element in the *currently visible* list
        function getTrackElement(direction) { // -1 for prev, 1 for next
            const activeList = document.querySelector('.tab-content.active');
            if (!activeList) return null;
            
            const currentActive = activeList.querySelector('li.active');
            if (!currentActive) return activeList.querySelector('li'); // Get first
            
            let nextTrackLi = (direction === 1) ? currentActive.nextElementSibling : currentActive.previousElementSibling;
            
            // Wrap around list
            if (!nextTrackLi) {
                if (direction === 1) {
                    nextTrackLi = activeList.querySelector('li:first-child');
                } else {
                    nextTrackLi = activeList.querySelector('li:last-child');
                }
            }
            return nextTrackLi;
        }
        
        function playNextTrack() {
            const nextTrackLi = getTrackElement(1);
            if (nextTrackLi) nextTrackLi.click(); // Simulate click
        }
        
        function playPreviousTrack() {
            const prevTrackLi = getTrackElement(-1);
            if (prevTrackLi) prevTrackLi.click();
        }

        // Auto-play next track
        audioPlayer.addEventListener('ended', () => {
            playNextTrack(); 
        });
        
        // Update lock screen info
        function updateMediaSession(trackName, isMix) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: trackName,
                    artist: 'Ilan Reiss',
                    album: isMix ? 'Mixes' : 'Ilan Reiss Music Player',
                    artwork: [
                        { src: 'cover.png', sizes: '512x512', type: 'image/png' }
                    ]
                });

                // Set handlers
                navigator.mediaSession.setActionHandler('play', () => audioPlayer.play());
                navigator.mediaSession.setActionHandler('pause', () => audioPlayer.pause());
                navigator.mediaSession.setActionHandler('previoustrack', () => playPreviousTrack());
                navigator.mediaSession.setActionHandler('nexttrack', () => playNextTrack());
            }
        }

        
        // Info button
        infoButton.addEventListener('click', () => {
            infoWindow.style.display = 'flex';
            if (!isMobile) bringWindowToFront(infoWindow);
        });
        
        // --- Window Button Listeners (Close, Minimize, Restore) ---
        
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetWindowId = e.target.dataset.target;
                const windowToClose = document.getElementById(targetWindowId);
                if (windowToClose) {
                    windowToClose.style.display = 'none';
                    if (targetWindowId === 'player-container') {
                        minimizedPlayerIcon.style.display = 'flex';
                    } else if (targetWindowId === 'dj-app-window') {
                        minimizedDjIcon.style.display = 'none'; // Hide minimized icon
                        openDjAppIcon.style.display = 'flex'; // Show open icon
                    } else if (targetWindowId === 'visualizer-window') {
                        stopVisualizer();
                    }
                }
            });
        });

        minimizePlayerButton.addEventListener('click', () => {
            playerContainer.style.display = 'none';
            minimizedPlayerIcon.style.display = 'flex';
        });

        minimizedPlayerIcon.addEventListener('click', () => {
            playerContainer.style.display = 'flex';
            minimizedPlayerIcon.style.display = 'none';
            if (!isMobile) bringWindowToFront(playerContainer);
        });
        
        openDjAppIcon.addEventListener('click', () => {
            djAppWindow.style.display = 'flex';
            openDjAppIcon.style.display = 'none'; 
            minimizedDjIcon.style.display = 'none'; 
            if (!isMobile) bringWindowToFront(djAppWindow);
        });
        
        minimizeDjButton.addEventListener('click', () => {
            djAppWindow.style.display = 'none';
            minimizedDjIcon.style.display = 'flex'; 
            openDjAppIcon.style.display = 'none'; 
        });
        
        minimizedDjIcon.addEventListener('click', () => {
            djAppWindow.style.display = 'flex';
            minimizedDjIcon.style.display = 'none'; 
            openDjAppIcon.style.display = 'none'; 
            if (!isMobile) bringWindowToFront(djAppWindow);
        });

        // Visualizer tab switching
        visualizerTabs.addEventListener('click', (e) => {
            const clickedTab = e.target.closest('.visualizer-tab');
            if (clickedTab) {
                document.querySelectorAll('.visualizer-tab').forEach(tab => tab.classList.remove('active'));
                clickedTab.classList.add('active');
                activeVisualizer = clickedTab.dataset.visualizer;
                if (visualizerActive) startVisualizer(); // Restart with new visualizer
            }
        });
        document.querySelector(`.visualizer-tab[data-visualizer="${activeVisualizer}"]`).classList.add('active');

        // --- Color Conversion Helper (Hex to HSL) ---
        function hexToHSL(H) {
            let r = 0, g = 0, b = 0;
            if (H.length == 4) { r = parseInt(H[1] + H[1], 16); g = parseInt(H[2] + H[2], 16); b = parseInt(H[3] + H[3], 16); }
            else if (H.length == 7) { r = parseInt(H.substring(1, 3), 16); g = parseInt(H.substring(3, 5), 16); b = parseInt(H.substring(5, 7), 16); }
            r /= 255; g /= 255; b /= 255;
            let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
            if (delta == 0) h = 0; else if (cmax == r) h = ((g - b) / delta) % 6;
            else if (cmax == g) h = (b - r) / delta + 2; else h = (r - g) / delta + 4;
            h = Math.round(h * 60); if (h < 0) h += 360;
            l = (cmax + cmin) / 2;
            s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
            s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
            return {h, s, l};
        }

        // --- Background Color Picker ---
        bgColorPicker.addEventListener('input', (e) => {
            const newColor = e.target.value;
            document.body.style.background = newColor;
            // Update visualizer colors based on background
            const hsl = hexToHSL(newColor);
            visualizerColor = `hsl(${hsl.h}, 100%, 65%)`;
            secondaryColor = `hsl(${(hsl.h + 180) % 360}, 100%, 65%)`;
        });

        // --- Digital Clock ---
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 o'clock is 12
            digitalClock.textContent = `${hours}:${minutes} ${ampm}`;
        }
        setInterval(updateClock, 1000);
        updateClock();
        
        // --- Playlist & Context Menu Logic ---
        
        // Load playlists from localStorage
        function loadPlaylists() {
            const playlistsStr = localStorage.getItem('ilanPlaylists');
            if (playlistsStr) {
                playlists = JSON.parse(playlistsStr);
            }
            renderPlaylistList();
        }
        
        // Save playlists to localStorage
        function savePlaylists() {
            localStorage.setItem('ilanPlaylists', JSON.stringify(playlists));
        }
        
        // Redraw the list of playlists
        function renderPlaylistList() {
            playlistList.innerHTML = '';
            playlists.forEach(playlist => {
                const li = document.createElement('li');
                li.textContent = playlist.name;
                li.dataset.id = playlist.id;
                if (playlist.id === selectedPlaylistId) {
                    li.classList.add('selected');
                }
                // Click to select playlist
                li.addEventListener('click', () => {
                    selectedPlaylistId = playlist.id;
                    renderPlaylistList(); 
                    renderPlaylistTracks(playlist.id);
                });
                playlistList.appendChild(li);
            });
        }
        
        // Redraw the tracks inside the selected playlist
        function renderPlaylistTracks(playlistId) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (!playlist) {
                playlistTracks.innerHTML = '';
                playlistTracksTitle.textContent = 'Tracks';
                return;
            }
            
            playlistTracksTitle.textContent = `Tracks in "${playlist.name}"`;
            playlistTracks.innerHTML = '';
            
            if (playlist.tracks.length === 0) {
                 playlistTracks.innerHTML = '<li style="color: #808080; font-style: italic; padding: 10px 5px;">This playlist is empty.</li>';
                 return;
            }
            
            playlist.tracks.forEach(trackName => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="playlist-track-name">${trackName.replace('.mp3', '')}</span>
                    <button class="window-button playlist-track-remove" data-track="${trackName}">X</button>
                `;
                
                // Click track name to play it
                li.querySelector('.playlist-track-name').addEventListener('click', () => {
                    const trackLi = fileListElement.querySelector(`li[data-filename="${CSS.escape(trackName)}"]`);
                    if (trackLi) trackLi.click();
                });
                
                // Click 'X' to remove from playlist
                li.querySelector('.playlist-track-remove').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeTrackFromPlaylist(playlistId, trackName);
                });
                
                playlistTracks.appendChild(li);
            });
        }
        
        function removeTrackFromPlaylist(playlistId, trackName) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (playlist) {
                playlist.tracks = playlist.tracks.filter(t => t !== trackName);
                savePlaylists();
                renderPlaylistTracks(playlistId); // Refresh view
            }
        }
        
        // Open playlist window
        openPlaylistsButton.addEventListener('click', () => {
            playlistWindow.style.display = 'flex';
            if (!isMobile) bringWindowToFront(playlistWindow);
        });
        
        // New playlist
        newPlaylistButton.addEventListener('click', () => {
            const name = prompt("Enter new playlist name:", "New Playlist");
            if (name && name.trim()) {
                const newPlaylist = {
                    id: `pid-${Date.now()}`,
                    name: name.trim(),
                    tracks: []
                };
                playlists.push(newPlaylist);
                savePlaylists();
                renderPlaylistList();
            }
        });
        
        // Rename playlist
        renamePlaylistButton.addEventListener('click', () => {
            if (!selectedPlaylistId) {
                customAlert("Please select a playlist to rename."); 
                return;
            }
            const playlist = playlists.find(p => p.id === selectedPlaylistId);
            if (!playlist) return;
            
            const newName = prompt("Enter new name:", playlist.name);
            if (newName && newName.trim()) {
                playlist.name = newName.trim();
                savePlaylists();
                renderPlaylistList();
                if (playlist.id === selectedPlaylistId) {
                    playlistTracksTitle.textContent = `Tracks in "${playlist.name}"`;
                }
            }
        });
        
        // Delete playlist
        deletePlaylistButton.addEventListener('click', async () => { 
            if (!selectedPlaylistId) {
                customAlert("Please select a playlist to delete.");
                return;
            }
            
            const playlist = playlists.find(p => p.id === selectedPlaylistId);
            if (!playlist) return;
            
            // Use custom confirm modal
            if (await customConfirm(`Are you sure you want to delete the playlist "${playlist.name}"?`)) { 
                playlists = playlists.filter(p => p.id !== selectedPlaylistId);
                selectedPlaylistId = null;
                savePlaylists();
                renderPlaylistList();
                renderPlaylistTracks(null); 
            }
        });
        
        // '+' button (add currently playing)
        addTrackNowPlayingButton.addEventListener('click', (e) => {
            if (currentMainPlayerTab !== 'tracks') {
                customAlert("You can only add tracks to a playlist, not mixes.");
                return;
            }
            const currentActive = fileListElement.querySelector('.active');
            if (currentActive) {
                const filename = currentActive.dataset.filename;
                showContextMenu(e, filename);
            } else {
                customAlert("Play a track first to add it to a playlist.");
            }
        });
        
        // Show context menu (right-click or long press)
        function showContextMenu(e, trackName) {
            contextMenuTrack = trackName;
            
            // Populate submenu with playlist names
            contextMenuPlaylistList.innerHTML = '';
            if (playlists.length === 0) {
                const li = document.createElement('li');
                li.textContent = "(No playlists)";
                li.style.fontStyle = "italic";
                li.style.color = "#808080";
                contextMenuPlaylistList.appendChild(li);
            } else {
                playlists.forEach(playlist => {
                    const li = document.createElement('li');
                    li.textContent = playlist.name;
                    li.dataset.id = playlist.id;
                    // Click to add song
                    li.addEventListener('click', (event) => {
                        event.stopPropagation(); // Stop click from closing menu
                        addTrackToPlaylist(playlist.id, contextMenuTrack);
                        hideContextMenu();
                    });
                    contextMenuPlaylistList.appendChild(li);
                });
            }
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            contextMenu.style.display = 'block';
            
            // Set position *before* measuring
            contextMenu.style.left = `${clientX}px`;
            contextMenu.style.top = `${clientY}px`;
            
            // Reposition to fit on screen
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;
            const submenu = contextMenu.querySelector('#add-to-playlist-submenu');
            const submenuWidth = submenu.offsetWidth || 150; 
            
            let posX = clientX;
            let posY = clientY;

            // Flip submenu to left if it overflows right
            if (clientX + menuWidth + submenuWidth > window.innerWidth) {
                 submenu.style.left = '-100%'; 
            } else {
                 submenu.style.left = '100%'; 
            }
            
            // Constrain main menu to viewport
            if (clientX + menuWidth > window.innerWidth) {
                 posX = window.innerWidth - menuWidth - 5;
            }
            if (clientY + menuHeight > window.innerHeight) {
                posY = window.innerHeight - menuHeight - 5;
            }

            contextMenu.style.left = `${posX}px`;
            contextMenu.style.top = `${posY}px`;
        }
        
        function hideContextMenu() {
            contextMenu.style.display = 'none';
            contextMenuTrack = null;
        }
        
        function addTrackToPlaylist(playlistId, trackName) {
            const playlist = playlists.find(p => p.id === playlistId);
            if (playlist) {
                // Add only if not already in list
                if (!playlist.tracks.includes(trackName)) {
                    playlist.tracks.push(trackName);
                    savePlaylists();
                    console.log(`Added "${trackName}" to "${playlist.name}"`);
                    // Refresh view if it's the open playlist
                    if (playlistId === selectedPlaylistId) {
                        renderPlaylistTracks(playlistId);
                    }
                } else {
                    console.warn(`Track "${trackName}" is already in "${playlist.name}"`);
                }
            }
        }
        
        // Global click to hide context menu
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });
        document.addEventListener('touchstart', (e) => {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        }, { passive: true });


        // --- Final Setup ---
        loadPlaylists(); // Load saved playlists on start
        
        // Initial visualizer color sync
        const initialBgColor = bgColorPicker.value;
        const initialHsl = hexToHSL(initialBgColor);
        visualizerColor = `hsl(${initialHsl.h}, 100%, 65%)`;
        secondaryColor = `hsl(${(initialHsl.h + 180) % 360}, 100%, 65%)`;

        // Preload cover image for lock screen
        const lockScreenImage = new Image();
        lockScreenImage.src = "cover.png"; 
        lockScreenImage.style.display = 'none';
        document.body.appendChild(lockScreenImage);
    });
</script>
</body>
</html>


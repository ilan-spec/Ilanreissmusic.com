<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ilan Reiss Music Player</title>
    
    <!-- iOS & PWA Goodies -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Ilan Reiss Music">
    <!-- Make sure cover.png is in the root of your repo -->
    <link rel="apple-touch-icon" href="cover.png"> 

    <!-- Theme Color -->
    <meta name="theme-color" content="#008080"> 

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            touch-action: pan-y; /* Default: allow vertical scroll, but can be overridden */
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            color: #000;
            background: #008080;
            overflow: hidden;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Prevent browser touch gestures on the body */
        }

        .window {
            display: flex;
            flex-direction: column;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            position: absolute;
            min-width: 300px; /* Increased base min-width */
            min-height: 200px; /* Increased base min-height */
            z-index: 10; /* Default stacking order */
        }
 
        .window.active-window {
            z-index: 100; /* Bring active window to front */
        }
        
        .player-container {
            width: 90%;
            max-width: 800px; 
            height: 85vh; 
            max-height: 750px; 
            min-width: 450px; /* Specific min-width for player */
            min-height: 550px; /* Specific min-height for player */
        }
 
        .title-bar {
            padding: 5px 8px;
            font-weight: 700;
            font-size: 1rem;
            color: #fff; 
            background: linear-gradient(to right, #000080, #1084d0);
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            touch-action: none; /* Crucial for touch drag */
        }
        
        .title-bar-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            margin-right: 5px;
        }
        
        .title-bar-buttons {
            display: flex;
            gap: 3px;
            flex-shrink: 0;
        }

        .window-button {
            width: 18px;
            height: 18px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 12px;
            font-weight: 900;
            color: #000;
            text-align: center;
            line-height: 16px;
            cursor: pointer;
            flex-shrink: 0;
            touch-action: manipulation; /* Allow button tap, prevent accidental drag */
        }
        .window-button:active, .window-button.active {
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
        }

        .content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden;
            border-top: 1px solid #808080;
        }
        
        .content-inner {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden;
        }
        
        .search-sort-container {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            align-items: center;
        }

        #search-bar {
            flex-grow: 1; /* Search bar takes available space */
            padding: 8px 10px;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            background: #fff;
            color: #000;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
        }
        
        .sort-button {
             width: 40px;
             height: 34px; /* Match search bar height */
             padding: 0;
             font-weight: 700;
             font-size: 11px; /* Fit text */
        }

        #search-bar::placeholder {
            color: #808080;
        }

        .file-browser {
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 10px;
            flex-grow: 1; 
            overflow-y: auto;
            touch-action: pan-y; /* Allow vertical scrolling inside file browser */
        }

        #file-list {
            list-style-type: none;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        #file-list li {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            border-radius: 0;
            cursor: pointer;
            transition: none;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            color: #000;
            background: transparent;
            border: 1px solid transparent;
            height: 100px;
        }
        
        #file-list li:hover {
            background: transparent;
        }

        #file-list li .file-icon {
            font-size: 2.5rem;
            color: #000080;
            margin-bottom: 8px;
            text-shadow: none;
        }

        #file-list li.active .file-icon {
            color: #ffffff;
        }

        #file-list li .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            color: #000;
            padding: 2px 4px;
        }

        #file-list li.active {
            background: #000080;
            color: #fff;
        }
        
        #file-list li.active .file-name {
             color: #fff;
        }

        .player-controls {
            flex-shrink: 0;
        }

        #now-playing {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #000;
            margin-bottom: 10px;
            padding: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #audio-player {
            width: 100%;
        }

        ::-webkit-scrollbar {
            width: 16px;
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-track {
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
        }
        
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background: repeating-linear-gradient(
                -45deg,
                #c0c0c0,
                #c0c0c0 2px,
                #404040 2px,
                #404040 4px,
                #fff 4px,
                #fff 6px
            );
            cursor: nwse-resize;
            z-index: 100;
            touch-action: none; /* Crucial for touch resize */
        }
        
        #visualizer-window {
            width: 350px;
            height: 200px;
            top: 20px;
            left: 20px;
            display: none;
        }
        
        #visualizer-canvas {
            width: 100%;
            height: 100%;
            background: #000;
            display: block;
        }

        /* New Visualizer Tabs */
        #visualizer-tabs {
            display: flex;
            flex-grow: 1; /* Allow tabs to take space */
            margin-right: 5px;
            justify-content: flex-start; /* Align tabs to the left */
        }
        .visualizer-tab {
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            padding: 3px 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 2px;
            color: #000;
            touch-action: manipulation;
        }
        .visualizer-tab.active {
            background: #000080;
            color: #fff;
            border-bottom: none;
            position: relative;
            top: 1px;
        }
        /* Override window-button styling for tabs */
        .visualizer-tab.window-button {
             width: auto;
             height: auto;
             line-height: normal;
        }

        #info-window {
            width: 300px;
            height: 250px;
            top: 150px;
            left: 100px;
            display: none;
        }
        
        #info-window .content {
            padding: 15px;
            font-size: 0.9rem;
        }

        #info-window p {
            margin-bottom: 8px;
        }
        
        #info-button {
            width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: #000080;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
            margin-top: 5px;
            align-self: flex-start;
        }
        #info-button:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }

        #digital-clock {
            position: fixed;
            bottom: 0;
            right: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            font-size: 1rem;
            font-weight: 600;
            z-index: 1000;
            border-bottom: none;
            border-right: none;
        }
        
        #color-picker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            z-index: 1000;
            border-bottom: none;
            border-left: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #color-picker-container label {
            font-size: 1rem;
            font-weight: 600;
        }
        
        #bg-color-picker {
            width: 40px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            cursor: pointer;
            padding: 0;
        }
        
        #bg-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #bg-color-picker::-webkit-color-swatch {
            border: none;
        }

        /* Minimized Player Icon */
        #minimized-player-icon {
            width: 25px; /* Match height of color picker */
            height: 25px; /* Match height of color picker */
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem; /* Smaller icon */
            color: #000080;
            margin-left: 10px; /* Add space */
        }
        #minimized-player-icon:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }
        
        /* --- DJ App Styles --- */
        #open-dj-app-icon {
            width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #000080;
            margin-left: 10px;
        }
        #open-dj-app-icon:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }
        
        #minimized-dj-icon {
             width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            color: #000080;
            margin-left: 10px;
        }
        #minimized-dj-icon:active {
              border-top: 2px solid #404040;
             border-left: 2px solid #404040;
             border-right: 2px solid #fff;
             border-bottom: 2px solid #fff;
         }
         
         #dj-app-window {
             width: 80vw; /* Smaller width */
             max-width: 900px; /* Smaller max-width */
             height: 550px; /* Smaller height */
             min-width: 600px;
             min-height: 400px;
            display: none; /* Hidden by default */
        }
        
        #dj-app-window .content {
            flex-direction: row; /* Horizontal layout */
            overflow: hidden;
            background: #808080; /* Darker grey bg */
        }
        
        .deck-container {
            flex: 1.5; /* Decks take LESS space */
            display: flex;
            flex-direction: column;
            background: #c0c0c0;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 10px;
            gap: 10px;
        }
        
        #dj-library-container {
            flex: 2; /* Library in the middle (WIDER) */
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            overflow: hidden;
        }
        
        #dj-library-header {
            padding: 5px;
            border-bottom: 2px solid #c0c0c0;
            flex-shrink: 0;
        }
        
        #dj-library-list {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
            padding: 5px;
            touch-action: pan-y;
        }
        
        #dj-library-list li {
            padding: 6px 8px;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #dj-library-list li:hover {
            background: #e0e0e0;
        }
        
        #dj-library-list li.selected {
            background: #000080;
            color: #fff;
        }
        
        .dj-track-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        
        .dj-track-bpm {
            flex-shrink: 0;
            color: #404040;
            border: 1px solid #808080;
            width: 60px; /* Give it a fixed width */
            text-align: right;
            padding: 2px;
            font-size: 0.85rem;
            -moz-appearance: textfield; /* Firefox */
        }
        
        .dj-track-bpm::-webkit-outer-spin-button,
        .dj-track-bpm::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #dj-library-list li.selected .dj-track-bpm {
            color: #000; /* Keep text black for readability on white bg */
            background: #fff;
        }
        
        .track-name-display {
            height: 40px;
            background: #fff;
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 8px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .load-button {
            height: 30px;
            font-weight: 700;
        }
        
        .scrub-bar {
            width: 100%;
            height: 20px;
            cursor: pointer;
        }
        
        .deck-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .deck-controls .window-button {
            width: 50px;
            height: 30px;
        }
        
        .volume-slider-container {
            display: flex;
            justify-content: center;
            flex-grow: 1;
            padding: 10px 0;
        }
        
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 80%;
            height: 15px;
            background: #808080;
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
            outline: none;
            writing-mode: vertical-lr; /* Flip to vertical */
            transform: rotate(180deg); /* Point up */
            width: 20px; /* Fixed width for vertical slider */
            height: 150px; /* Fixed height */
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 15px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="player-container window" id="player-container">
        <div class="title-bar">
            <span class="title-bar-text">üéµ Ilan Reiss Music Player</span>
            <div class="title-bar-buttons">
                <button class="window-button" id="minimize-player-button">_</button>
                <button class="window-button close-button" data-target="player-container">X</button>
            </div>
        </div>
        
        <div class="content">
            <div class="player-controls">
                <span id="now-playing">Select a track to play</span>
                <audio id="audio-player" controls crossorigin="anonymous"></audio>
            </div>
            
            <div class="content-inner">
                <div class="search-sort-container">
                    <input type="text" id="search-bar" placeholder="Search tracks...">
                    <button id="sort-az" class="window-button sort-button">A-Z</button>
                    <button id="sort-za" class="window-button sort-button">Z-A</button>
                    <button id="bitcrush-toggle" class="window-button sort-button" title="Toggle 12-Bit Audio">12-Bit</button>
                </div>

                <div class="file-browser">
                    <ul id="file-list"></ul>
                </div>
                 <button id="info-button" class="window-button">i</button>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <div id="visualizer-window" class="window">
         <div class="title-bar">
            <div id="visualizer-tabs">
                <button class="visualizer-tab window-button" data-visualizer="nostalgiaWindows">Nostalgia</button>
                <button class="visualizer-tab window-button" data-visualizer="aeroEnergy">Aero Energy</button>
                <button class="visualizer-tab window-button" data-visualizer="retroWaveform">Retro Waveform</button>
            </div>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="visualizer-window">X</button>
            </div>
        </div>
        <div class="content" style="padding: 0; border: 2px inset #808080; border-top-color: #404040; border-left-color: #404040; border-right-color: #fff; border-bottom-color: #fff; background: #000;">
            <canvas id="visualizer-canvas"></canvas>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <div id="info-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">‚ÑπÔ∏è Ilan Reiss Music Player Info</span>
            <div class="title-bar-buttons">
                <button class="window-button close-button" data-target="info-window">X</button>
            </div>
        </div>
        <div class="content">
            <p>Hi, welcome to Ilan Reiss's site. Here is a collection of my tracks that I have produced over the past year. Dig to find the good ones.</p>
            <p>Version 2.0 (Enhanced Retro)</p>
            <br>
            <p>Follow me on Instagram: <a href="https://www.instagram.com/ilanreiss/" target="_blank">@ilanreiss</a></p>
            <br>
            <p><em>(You can edit this text in the ilanreissmusic.com.html file)</em></p>
        </div>
        <div class="resize-handle"></div>
    </div>

    <!-- DJ App Window -->
    <div id="dj-app-window" class="window">
        <div class="title-bar">
            <span class="title-bar-text">üéß DJ Decks</span>
            <div class="title-bar-buttons">
                <button class="window-button" id="minimize-dj-button">_</button>
                <button class="window-button close-button" data-target="dj-app-window">X</button>
            </div>
        </div>
        <div class="content">
            <!-- Deck A -->
            <div class="deck-container" id="deck-a">
                <div class="track-name-display" id="deck-a-display">DECK A</div>
                <button class="window-button load-button" id="load-deck-a">LOAD</button>
                <input type="range" class="scrub-bar" id="deck-a-scrub" value="0" min="0" max="1000">
                <div class="deck-controls">
                    <button class="window-button" id="deck-a-play">PLAY</button>
                    <button class="window-button" id="deck-a-pause">PAUSE</button>
                    <button class="window-button" id="deck-a-cue">CUE</button>
                </div>
                <div class="volume-slider-container">
                    <input type="range" class="volume-slider" id="deck-a-volume" value="1" min="0" max="1" step="0.01">
                </div>
                <audio id="deck-a-audio" crossorigin="anonymous"></audio>
            </div>
            
            <!-- Library -->
            <div id="dj-library-container">
                <div id="dj-library-header">
                    <button class="window-button sort-button" id="sort-bpm" style="width: 100%;">Sort by BPM</button>
                </div>
                <ul id="dj-library-list">
                    <!-- Tracks will be populated by JS -->
                </ul>
            </div>

            <!-- Deck B -->
            <div class="deck-container" id="deck-b">
                <div class="track-name-display" id="deck-b-display">DECK B</div>
                <button class="window-button load-button" id="load-deck-b">LOAD</button>
                <input type="range" class="scrub-bar" id="deck-b-scrub" value="0" min="0" max="1000">
                <div class="deck-controls">
                    <button class="window-button" id="deck-b-play">PLAY</button>
                    <button class="window-button" id="deck-b-pause">PAUSE</button>
                    <button class="window-button" id="deck-b-cue">CUE</button>
                </div>
                <div class="volume-slider-container">
                    <input type="range" class="volume-slider" id="deck-b-volume" value="1" min="0" max="1" step="0.01">
                </div>
                <audio id="deck-b-audio" crossorigin="anonymous"></audio>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <div id="digital-clock"></div>

    <div id="color-picker-container">
        <label for="bg-color-picker">BG:</label>
        <input type="color" id="bg-color-picker" value="#008080">
        
        <div id="minimized-player-icon" title="Restore Music Player">
            <i class="fas fa-headphones"></i> <!-- Changed icon -->
        </div>
        <div id="open-dj-app-icon" title="Open DJ App">
            <i class="fas fa-compact-disc"></i> <!-- Changed icon -->
        </div>
        <div id="minimized-dj-icon" title="Restore DJ App">
            <i class="fas fa-compact-disc"></i> <!-- Changed icon -->
        </div>
    </div>
 
    

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Configuration & Elements ---
        // ! IMPORTANT: BPM is SIMULATED with a random number.
        // Web browsers cannot analyze MP3s for BPM easily.
        const audioFiles = [
            "2 part shit.mp3", "42 cent.mp3", "67.mp3", "808 beat sample.mp3",
            "a break.mp3", "all me.mp3", "another one.mp3", "asher organ.mp3",
            "ass with potench.mp3", "bad one.mp3", "been a minu.mp3", "beeps.mp3",
            "before my set.mp3", "before you go.mp3", "black airforces.mp3",
            "bubs final.mp3", "bubs.mp3", "buds.mp3", "bullshittin.mp3",
            "candy shack.mp3", "chicos.mp3", "chilled.mp3", "com 303 sh.mp3",
            "corp. rework.mp3", "corp..mp3", "cya.mp3", "cypher chopped.mp3",
            "danklin.mp3", "day ones.mp3", "day today .mp3", "delete this track.mp3",
            "dub w.mp3", "easter.mp3", "ff.mp3", "flip.mp3", "fly guy.mp3",
            "for it.mp3", "for the car.mp3", "fridays.mp3", "fuckin idk.mp3",
            "funky.mp3", "gallery lazy break.mp3", "gallery.mp3", "giving in.mp3",
            "go 2.mp3", "goin crazy wit 10 racks.mp3", "goin crazy with 10 racks.mp3",
            "golf soundscape.mp3", "gover.mp3", "grizzlies ART.mp3", "grizzlies.mp3",
            "half life beat.mp3", "hammer down.mp3", "have it.mp3", "have to save.mp3",
            "hit the cart.mp3", "House on plane.mp3", "huh.mp3", "hyper fix.mp3",
            "i wanna.mp3", "insanity.mp3", "is ass.mp3", "jungled.mp3", "kenny.mp3",
            "kirked.mp3", "last of day.mp3", "lastly.mp3", "late.mp3", "lib beat.mp3",
            "locked.mp3", "lost it unfinished.mp3", "lyra demo.mp3", "ma.mp3",
            "making progress thru.mp3", "making progress.mp3", "mini 808.mp3",
            "MPC iPhone beat.mp3", "my amigo.mp3", "my sound scape.mp3",
            "new jersey club.mp3", "new setup.mp3", "niko again .mp3",
            "niko again unfinished.mp3", "niko is talking.mp3", "not done beat.mp3",
            "not thru.mp3", "not trash.mp3", "null.mp3", "number 3 shit.mp3",
            "On plane shiz.mp3", "postd.mp3", "practice.mp3", "quiky.mp3",
            "rabbits.mp3", "read up.mp3", "recipe.mp3", "redo.mp3", "reggae.mp3",
            "reggetons.mp3", "Reiss_Soundscape_edit.mp3", "Reiss_soundscape_raw.mp3",
            "rick poppa.mp3", "rythm.mp3", "same goal.mp3", "saturday morning.mp3",
            "saturn.mp3", "save rq.mp3", "saved it.mp3", "serup.mp3",
            "shit is trash.mp3", "shortest beat.mp3", "show class.mp3",
            "show trash.mp3", "slash slowed.mp3", "slash.mp3", "slow jam 2.mp3",
            "slow ride.mp3", "snippes.mp3", "soundbath 2.0.mp3", "soundbath.mp3",
            "SP iPhone sample.mp3", "spit it out.mp3", "standing in the rain.mp3",
            "starterd.mp3", "sue nami.mp3", "surfin.mp3", "swang.mp3",
            "swing song w eli.mp3", "synth demo.mp3", "take 2.mp3", "techno.mp3",
            "that way.mp3", "the monitor.mp3", "the worst beat ever.mp3",
            "this again.mp3", "threw together.mp3", "throw it up.mp3",
            "thursday.mp3", "trios.mp3", "trump-pets.mp3", "un house.mp3",
            "w issy.mp3", "watch it go.mp3", "week from today.mp3",
            "what am i doing.mp3", "what is this.mp3", "z style.mp3"
        ];
        
        // Create objects with simulated BPM
        const audioFileObjects = audioFiles.map(file => ({
            name: file,
            bpm: Math.floor(Math.random() * (160 - 90 + 1) + 90) // Random BPM between 90-160
        }));
        
        let currentTracklist = [...audioFileObjects]; // Array to hold the currently sorted list
        let currentDjTracklist = [...audioFileObjects]; // For the DJ library
        let selectedDjTrack = null; // Holds the name of the track clicked in the DJ library
        let djSortAscending = true; // For BPM sorting

        // Main Player elements
        const audioPlayer = document.getElementById('audio-player');
        const fileListElement = document.getElementById('file-list');
        const nowPlayingElement = document.getElementById('now-playing');
        const searchBar = document.getElementById('search-bar');
        const sortAzButton = document.getElementById('sort-az');
        const sortZaButton = document.getElementById('sort-za');
        const bitcrushToggle = document.getElementById('bitcrush-toggle');
        
        // Window elements
        const playerContainer = document.getElementById('player-container');
        const visualizerWindow = document.getElementById('visualizer-window');
        const infoWindow = document.getElementById('info-window');
        const infoButton = document.getElementById('info-button');
        const digitalClock = document.getElementById('digital-clock');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const visualizerTabs = document.getElementById('visualizer-tabs');
        const minimizePlayerButton = document.getElementById('minimize-player-button');
        const minimizedPlayerIcon = document.getElementById('minimized-player-icon');
        
        // DJ App elements
        const djAppWindow = document.getElementById('dj-app-window');
        const openDjAppIcon = document.getElementById('open-dj-app-icon');
        const minimizeDjButton = document.getElementById('minimize-dj-button');
        const minimizedDjIcon = document.getElementById('minimized-dj-icon');
        const djLibraryList = document.getElementById('dj-library-list');
        const sortBpmButton = document.getElementById('sort-bpm');
        
        // Visualizer elements
        const canvas = document.getElementById('visualizer-canvas');
        const ctx = canvas.getContext('2d');
        
        let visualizerColor = '#00FFFF';
        let secondaryColor = '#FF00FF';
        let activeVisualizer = 'nostalgiaWindows'; 

        // --- Audio Context Setup ---
        let audioContext, analyser, source;
        let bitCrusherNode; 
        let isBitcrushActive = false; 
        let frequencyData, timeDomainData;
        let bufferLength;
        let visualizerActive = false;
        let animationFrameId;

        function setupAudioContext() {
            if (audioContext) return;
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            analyser.smoothingTimeConstant = 0.8; 
            
            source = audioContext.createMediaElementSource(audioPlayer);
            
            bitCrusherNode = audioContext.createWaveShaper();
            const steps = Math.pow(2, 8);
            const curve = new Float32Array(65536);
            for (let i = 0; i < curve.length; i++) {
                const inputSample = (i / (curve.length - 1)) * 2 - 1;
                curve[i] = Math.round(inputSample * (steps / 2)) / (steps / 2);
            }
            bitCrusherNode.curve = curve;
            
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            
            bufferLength = analyser.frequencyBinCount;
            frequencyData = new Uint8Array(bufferLength);
            timeDomainData = new Uint8Array(bufferLength);
        }

        function toggleBitcrusher() {
            isBitcrushActive = !isBitcrushActive;
            analyser.disconnect();
            if (isBitcrushActive) {
                analyser.connect(bitCrusherNode);
                bitCrusherNode.connect(audioContext.destination);
                bitcrushToggle.classList.add('active');
            } else {
                if (bitCrusherNode) bitCrusherNode.disconnect();
                analyser.connect(audioContext.destination);
                bitcrushToggle.classList.remove('active');
            }
        }

        function startVisualizer() {
            if (visualizerActive && animationFrameId) {
                cancelAnimationFrame(animationFrameId); // Stop previous loop
            }
            visualizerActive = true;
            visualizerWindow.style.display = 'flex';
            drawVisualizer();
        }

        function stopVisualizer() {
            visualizerActive = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
        }

        // iPhone Lock Screen Fix: Pause visualizer when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Tab is hidden (or phone locked) - pause visualizer
                stopVisualizer();
            } else {
                // Tab is visible (or phone unlocked) - resume visualizer if audio is playing
                if (!audioPlayer.paused) {
                    startVisualizer();
                }
            }
        });


        function drawVisualizer() {
            if (!visualizerActive) {
                return;
            }

            animationFrameId = requestAnimationFrame(drawVisualizer);
            
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
            
            // Use a darker fade for the nostalgia visualizer
            const fadeAlpha = activeVisualizer === 'nostalgiaWindows' ? '0.05' : '0.1';
            ctx.fillStyle = `rgba(0, 0, 0, ${fadeAlpha})`; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            analyser.getByteFrequencyData(frequencyData);
            analyser.getByteTimeDomainData(timeDomainData);
            
            let bass = 0, mids = 0, highs = 0;
            const bassRange = [0, Math.floor(bufferLength * 0.05)]; 
            const midRange = [Math.floor(bufferLength * 0.05), Math.floor(bufferLength * 0.2)]; 
            const highRange = [Math.floor(bufferLength * 0.2), Math.floor(bufferLength * 0.4)]; 

            for (let i = bassRange[0]; i < bassRange[1]; i++) bass += frequencyData[i];
            for (let i = midRange[0]; i < midRange[1]; i++) mids += frequencyData[i];
            for (let i = highRange[0]; i < highRange[1]; i++) highs += frequencyData[i];

            let bassAvg = (bass / (bassRange[1] - bassRange[0]) || 0) / 255; // Normalize to 0-1
            let midsAvg = (mids / (midRange[1] - midRange[0]) || 0) / 255; // Normalize to 0-1
            let highsAvg = (highs / (highRange[1] - highRange[0]) || 0) / 255; // Normalize to 0-1

            switch (activeVisualizer) {
                case 'nostalgiaWindows':
                    drawNostalgiaVisualizer(bassAvg, midsAvg, highsAvg);
                    break;
                case 'aeroEnergy':
                    drawAeroEnergyVisualizer(bassAvg, midsAvg, highsAvg);
                    break;
                case 'retroWaveform':
                    drawRetroWaveformVisualizer(timeDomainData);
                    break;
            }
        }
        
        // --- Visualizer Implementations (Keep from previous) ---
        
        // Nostalgia Windows Visualizer (Starfield Tunnel)
        const stars = [];
        const maxStars = 400; // Reduced for performance
        let starfieldRotation = 0;
        let starfieldOrigin = { x: 0.5, y: 0.5, targetX: 0.5, targetY: 0.5 };

        class Star {
            constructor() {
                this.x = (Math.random() - 0.5) * canvas.width;
                this.y = (Math.random() - 0.5) * canvas.height;
                this.z = Math.random() * canvas.width;
                this.colorHue = 0;
            }
            update(bass, mids, highs, centerX, centerY) {
                const speed = 2 + bass * 20; 
                this.z -= speed;
                if (this.z <= 0) {
                    this.z = canvas.width;
                    this.x = (Math.random() - 0.5) * canvas.width;
                    this.y = (Math.random() - 0.5) * canvas.height;
                }
                const rotX = Math.cos(starfieldRotation) * this.x - Math.sin(starfieldRotation) * this.y;
                const rotY = Math.sin(starfieldRotation) * this.x + Math.cos(starfieldRotation) * this.y;
                this.x = rotX; this.y = rotY;
                this.colorHue = (hslToHex(visualizerColor).h + (this.z / canvas.width) * 360 + Date.now() * 0.01) % 360;
            }
            draw(ctx, centerX, centerY) {
                if (this.z <= 0) return;
                const k = 128 / this.z;
                const px = this.x * k + centerX;
                const py = this.y * k + centerY;
                if (px < 0 || px > canvas.width || py < 0 || py > canvas.height) {
                    this.z = 0; return;
                }
                const size = (1 - this.z / canvas.width) * 3;
                ctx.fillStyle = `hsl(${this.colorHue}, 100%, ${70 + (1 - this.z / canvas.width) * 30}%)`;
                ctx.beginPath();
                ctx.arc(px, py, Math.max(0.5, size), 0, Math.PI * 2);
                ctx.fill();
            }
        }
        for (let i = 0; i < maxStars; i++) stars.push(new Star());
        
        function drawNostalgiaVisualizer(bassAvg, midsAvg, highsAvg) {
            starfieldRotation += (midsAvg - 0.1) * 0.005;
            starfieldOrigin.targetX = 0.5 + (Math.sin(Date.now() * 0.0005) * 0.2) * bassAvg;
            starfieldOrigin.targetY = 0.5 + (Math.cos(Date.now() * 0.0005) * 0.2) * bassAvg;
            starfieldOrigin.x += (starfieldOrigin.targetX - starfieldOrigin.x) * 0.05;
            starfieldOrigin.y += (starfieldOrigin.targetY - starfieldOrigin.y) * 0.05;
            const centerX = canvas.width * starfieldOrigin.x;
            const centerY = canvas.height * starfieldOrigin.y;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(centerX, centerY);
            stars.forEach(star => {
                star.update(bassAvg, midsAvg, highsAvg, centerX, centerY);
                star.draw(ctx, 0, 0);
            });
            ctx.restore();
            const pulseSize = 10 + bassAvg * 50;
            const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, pulseSize);
            gradient.addColorStop(0, `hsla(${hslToHex(visualizerColor).h}, 100%, 75%, 0.3)`);
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(centerX, centerY, pulseSize, 0, Math.PI * 2);
            ctx.fill();
        }

        // Aero Energy Visualizer
        const aeroLines = [];
        const maxAeroLines = 35; // Reduced for performance
        class AeroLine {
            constructor(x, y, color1, color2) {
                this.x = x; this.y = y;
                this.points = [{x: x, y: y}];
                this.length = 10 + Math.random() * 50;
                this.speed = 1 + Math.random() * 3;
                this.angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.life = 1; this.color1 = color1; this.color2 = color2; this.age = 0;
            }
            update(bass, mids, highs) {
                this.x += this.vx; this.y += this.vy;
                this.vx += (Math.random() - 0.5) * highs * 0.5;
                this.vy += (Math.random() - 0.5) * highs * 0.5;
                if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                this.points.unshift({x: this.x, y: this.y});
                if (this.points.length > this.length) this.points.pop();
                this.life -= 0.005 - (mids) * 0.002;
                if (this.life <= 0) this.life = 0;
                this.age++;
            }
            draw(ctx) {
                if (this.points.length < 2) return;
                ctx.globalAlpha = this.life;
                ctx.lineWidth = 2 + (this.age / 400);
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                const gradient = ctx.createLinearGradient(this.points[0].x, this.points[0].y, this.points[this.points.length - 1].x, this.points[this.points.length - 1].y);
                gradient.addColorStop(0, this.color1);
                gradient.addColorStop(1, this.color2);
                ctx.strokeStyle = gradient;
                ctx.shadowColor = this.color1;
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.moveTo(this.points[0].x, this.points[0].y);
                for (let i = 1; i < this.points.length; i++) ctx.lineTo(this.points[i].x, this.points[i].y);
                ctx.stroke();
                ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
            }
        }
        function drawAeroEnergyVisualizer(bassAvg, midsAvg, highsAvg) {
            if (aeroLines.length < maxAeroLines && Math.random() < 0.05 + (midsAvg) * 0.1) {
                const startX = Math.random() * canvas.width;
                const startY = Math.random() * canvas.height;
                const hueShift = (Date.now() * 0.01) % 360;
                const dynamicSecondaryColor = `hsl(${(hslToHex(visualizerColor).h + hueShift) % 360}, 100%, 65%)`;
                aeroLines.push(new AeroLine(startX, startY, visualizerColor, dynamicSecondaryColor));
            }
            for (let i = aeroLines.length - 1; i >= 0; i--) {
                aeroLines[i].update(bassAvg, midsAvg, highsAvg);
                aeroLines[i].draw(ctx);
                if (aeroLines[i].life <= 0 || aeroLines[i].age > 1000) aeroLines.splice(i, 1);
            }
        }

        // Retro Waveform Visualizer
        function drawRetroWaveformVisualizer(timeDomainData) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 3; ctx.strokeStyle = visualizerColor;
            ctx.shadowColor = visualizerColor; ctx.shadowBlur = 10;
            ctx.beginPath();
            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const v = timeDomainData[i] / 128.0;
                const y = v * canvas.height / 2;
                if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height / 2); ctx.stroke();
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, visualizerColor);
            gradient.addColorStop(0.5, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, visualizerColor);
            ctx.fillStyle = gradient; ctx.globalAlpha = 0.2;
            ctx.beginPath(); x = 0;
            ctx.moveTo(0, canvas.height);
            for(let i = 0; i < bufferLength; i++) {
                const v = timeDomainData[i] / 128.0;
                const y = v * canvas.height / 2;
                ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(canvas.width, canvas.height);
            ctx.closePath(); ctx.fill();
            ctx.globalAlpha = 1.0; ctx.shadowBlur = 0;
        }

        // --- Window Management ---

        let activeWindow = null;
        let isDragging = false;
        let isResizing = false;
        let dragOffsetX, dragOffsetY;
        let resizeStartX, resizeStartY;
        let initialWidth, initialHeight;
        let playerLastX, playerLastY, playerLastWidth, playerLastHeight;
        let djLastX, djLastY, djLastWidth, djLastHeight; // For DJ window

        document.querySelectorAll('.window').forEach(windowEl => {
            windowEl.addEventListener('mousedown', () => bringWindowToFront(windowEl));
            windowEl.addEventListener('touchstart', () => bringWindowToFront(windowEl), { passive: true });
        });

        function bringWindowToFront(windowEl) {
            document.querySelectorAll('.window').forEach(win => {
                win.classList.remove('active-window');
            });
            windowEl.classList.add('active-window');
        }

        function handleDragStart(e, windowEl) {
            if (e.target.classList.contains('window-button') || e.target.classList.contains('visualizer-tab')) return;
            isDragging = true;
            activeWindow = windowEl;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            dragOffsetX = clientX - windowEl.offsetLeft;
            dragOffsetY = clientY - windowEl.offsetTop;
            document.body.style.cursor = 'move';
            if (e.cancelable) e.preventDefault();
        }

        function handleDragMove(e) {
            if (!isDragging || !activeWindow) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let newX = clientX - dragOffsetX;
            let newY = clientY - dragOffsetY;
            newX = Math.max(0, Math.min(newX, window.innerWidth - activeWindow.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - activeWindow.offsetHeight));
            activeWindow.style.left = newX + 'px';
            activeWindow.style.top = newY + 'px';
            if (e.cancelable) e.preventDefault();
        }

        function handleResizeStart(e, windowEl) {
            isResizing = true;
            activeWindow = windowEl;
            resizeStartX = e.touches ? e.touches[0].clientX : e.clientX;
            resizeStartY = e.touches ? e.touches[0].clientY : e.clientY;
            initialWidth = windowEl.offsetWidth;
            initialHeight = windowEl.offsetHeight;
            document.body.style.cursor = 'nwse-resize';
            if (e.cancelable) e.preventDefault();
        }

        function handleResizeMove(e) {
            if (!isResizing || !activeWindow) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            let newWidth = initialWidth + (clientX - resizeStartX);
            let newHeight = initialHeight + (clientY - resizeStartY);
            const style = window.getComputedStyle(activeWindow);
            const minW = parseFloat(style.minWidth) || 250;
            const minH = parseFloat(style.minHeight) || 150;
            newWidth = Math.max(minW, newWidth);
            newHeight = Math.max(minH, newHeight);
            activeWindow.style.width = newWidth + 'px';
            activeWindow.style.height = newHeight + 'px';
            if (e.cancelable) e.preventDefault();
        }

        function handleEnd() {
            isDragging = false;
            isResizing = false;
            activeWindow = null;
            document.body.style.cursor = 'default';
        }

        document.querySelectorAll('.window').forEach(windowEl => {
            const titleBar = windowEl.querySelector('.title-bar');
            const resizeHandle = windowEl.querySelector('.resize-handle');
            if(titleBar) {
                titleBar.addEventListener('mousedown', (e) => handleDragStart(e, windowEl));
                titleBar.addEventListener('touchstart', (e) => handleDragStart(e, windowEl), { passive: false });
            }
            if (resizeHandle) {
                resizeHandle.addEventListener('mousedown', (e) => handleResizeStart(e, windowEl));
                resizeHandle.addEventListener('touchstart', (e) => handleResizeStart(e, windowEl), { passive: false });
            }
        });

        document.addEventListener('mousemove', handleDragMove);
        document.addEventListener('touchmove', handleDragMove, { passive: false });
        document.addEventListener('mousemove', handleResizeMove);
        document.addEventListener('touchmove', handleResizeMove, { passive: false });
        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);
 
        // --- Initialize Window Positions ---
        function setInitialPlayerPosition() {
            const style = window.getComputedStyle(playerContainer);
            playerLastWidth = parseFloat(style.width) || playerContainer.offsetWidth;
            playerLastHeight = parseFloat(style.height) || playerContainer.offsetHeight;
            playerLastX = (window.innerWidth - playerLastWidth) / 2;
            playerLastY = (window.innerHeight - playerLastHeight) / 2;
            
            playerContainer.style.left = playerLastX + 'px';
            playerContainer.style.top = playerLastY + 'px';
            playerContainer.style.width = playerLastWidth + 'px';
            playerContainer.style.height = playerLastHeight + 'px';
        }
        setInitialPlayerPosition();
        
        function setInitialDjPosition() {
            // Read from CSS styles instead of offsetHeight
            const style = window.getComputedStyle(djAppWindow);
            djLastWidth = parseFloat(style.width) || 900; // Match new max-width
            djLastHeight = parseFloat(style.height) || 550; // Match new height
            
            djLastX = (window.innerWidth - djLastWidth) / 2;
            djLastY = (window.innerHeight - djLastHeight) / 2;
            
            djAppWindow.style.left = djLastX + 'px';
            djAppWindow.style.top = djLastY + 'px';
            djAppWindow.style.width = djLastWidth + 'px';
            djAppWindow.style.height = djLastHeight + 'px';
        }
        // Set its initial position even if hidden
        // We call this *when the window is opened* to avoid issues
        
        visualizerWindow.style.left = '20px';
        visualizerWindow.style.top = '20px';
        infoWindow.style.left = (window.innerWidth - infoWindow.offsetWidth) / 2 + 'px';
        infoWindow.style.top = (window.innerHeight - infoWindow.offsetHeight) / 2 + 'px';
        bringWindowToFront(playerContainer);

        // --- Populate & Sort File List (Main Player) ---
        function populateFileList(files) {
            fileListElement.innerHTML = ''; // Clear list
            files.forEach(fileObj => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <i class="fas fa-music file-icon"></i>
                    <span class="file-name">${fileObj.name.replace('.mp3', '')}</span>
                `;
                li.dataset.filename = fileObj.name;
                fileListElement.appendChild(li);
            });
        }
        populateFileList(currentTracklist);

        sortAzButton.addEventListener('click', () => {
            currentTracklist.sort((a, b) => a.name.localeCompare(b.name));
            populateFileList(currentTracklist);
        });

        sortZaButton.addEventListener('click', () => {
            currentTracklist.sort((a, b) => b.name.localeCompare(a.name));
            populateFileList(currentTracklist);
        });
        
        // --- DJ App Logic ---
        function populateDjLibrary(files) {
            djLibraryList.innerHTML = '';
            files.forEach(fileObj => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="dj-track-name">${fileObj.name.replace('.mp3', '')}</span>
                    <input type="number" class="dj-track-bpm" value="${fileObj.bpm}" data-filename="${fileObj.name}">
                `;
                
                // Click to select track
                li.addEventListener('click', (e) => {
                    if (e.target.tagName === 'INPUT') return; // Don't select if clicking input
                    const current = djLibraryList.querySelector('.selected');
                    if (current) current.classList.remove('selected');
                    li.classList.add('selected');
                    selectedDjTrack = fileObj.name;
                });
                
                // Manual BPM input
                const bpmInput = li.querySelector('.dj-track-bpm');
                bpmInput.addEventListener('input', (e) => {
                    const newBpm = parseInt(e.target.value, 10);
                    if (!isNaN(newBpm)) {
                        const trackToUpdate = currentDjTracklist.find(f => f.name === fileObj.name);
                        if (trackToUpdate) {
                            trackToUpdate.bpm = newBpm;
                        }
                    }
                });
                
                djLibraryList.appendChild(li);
            });
        }
        populateDjLibrary(currentDjTracklist); // Initial load
        
        sortBpmButton.addEventListener('click', () => {
            if (djSortAscending) {
                currentDjTracklist.sort((a, b) => a.bpm - b.bpm);
                sortBpmButton.textContent = "Sort BPM (Hi-Lo)";
            } else {
                currentDjTracklist.sort((a, b) => b.bpm - a.bpm);
                sortBpmButton.textContent = "Sort BPM (Lo-Hi)";
            }
            djSortAscending = !djSortAscending;
            populateDjLibrary(currentDjTracklist);
        });

        function setupDeck(deckId) {
            const audio = document.getElementById(`${deckId}-audio`);
            const display = document.getElementById(`${deckId}-display`);
            const loadBtn = document.getElementById(`load-${deckId}`);
            const playBtn = document.getElementById(`${deckId}-play`);
            const pauseBtn = document.getElementById(`${deckId}-pause`);
            const cueBtn = document.getElementById(`${deckId}-cue`);
            const scrubBar = document.getElementById(`${deckId}-scrub`);
            const volumeSlider = document.getElementById(`${deckId}-volume`);

            let isScrubbing = false;

            loadBtn.addEventListener('click', () => {
                if (selectedDjTrack) {
                    audio.src = 'Audio/' + selectedDjTrack;
                    display.textContent = selectedDjTrack.replace('.mp3', '');
                    audio.load();
                }
            });

            playBtn.addEventListener('click', () => audio.play());
            pauseBtn.addEventListener('click', () => audio.pause());
            cueBtn.addEventListener('click', () => {
                audio.currentTime = 0;
                audio.pause();
            });

            volumeSlider.addEventListener('input', () => {
                audio.volume = volumeSlider.value;
            });

            audio.addEventListener('timeupdate', () => {
                if (!isScrubbing && audio.duration) {
                    scrubBar.value = (audio.currentTime / audio.duration) * 1000;
                }
            });
            
            const handleScrub = () => {
                if (audio.duration) {
                    audio.currentTime = (scrubBar.value / 1000) * audio.duration;
                }
            };
            
            scrubBar.addEventListener('mousedown', () => isScrubbing = true);
            scrubBar.addEventListener('touchstart', () => isScrubbing = true, { passive: true });
            
            scrubBar.addEventListener('input', handleScrub);
            
            scrubBar.addEventListener('mouseup', () => isScrubbing = false);
            scrubBar.addEventListener('touchend', () => isScrubbing = false);
        }
        
        setupDeck('deck-a');
        setupDeck('deck-b');


        // --- Main Player Event Listeners ---
        
        bitcrushToggle.addEventListener('click', () => {
            if (!audioContext) setupAudioContext();
            toggleBitcrusher();
        });

        fileListElement.addEventListener('click', (event) => {
            const clickedLi = event.target.closest('li');
            if (clickedLi) {
                const filename = clickedLi.dataset.filename;
                audioPlayer.src = 'Audio/' + filename;
                
                setupAudioContext(); 
                if (audioContext.state === 'suspended') audioContext.resume();
                
                audioPlayer.play();
                nowPlayingElement.textContent = clickedLi.querySelector('.file-name').textContent;
                
                const currentActive = fileListElement.querySelector('.active');
                if (currentActive) currentActive.classList.remove('active');
                clickedLi.classList.add('active');
                
                startVisualizer();
            }
        });
        
        audioPlayer.addEventListener('pause', () => { /* stopVisualizer(); */ });
        audioPlayer.addEventListener('play', () => {
            if (audioContext) {
                audioContext.resume();
                startVisualizer();
            }
        });

        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredList = currentTracklist.filter(fileObj => 
                fileObj.name.toLowerCase().replace('.mp3', '').includes(searchTerm)
            );
            populateFileList(filteredList);
        });

        audioPlayer.addEventListener('ended', () => {
            const currentActive = fileListElement.querySelector('.active');
            if (currentActive) {
                let nextTrackLi = currentActive.nextElementSibling;
                if (!nextTrackLi) {
                    const currentFile = currentActive.dataset.filename;
                    const currentIndex = currentTracklist.findIndex(f => f.name === currentFile);
                    if (currentIndex > -1 && currentIndex < currentTracklist.length - 1) {
                        const nextFile = currentTracklist[currentIndex + 1].name;
                        nextTrackLi = fileListElement.querySelector(`li[data-filename="${CSS.escape(nextFile)}"]`);
                    } else {
                        const firstFile = currentTracklist[0].name;
                        nextTrackLi = fileListElement.querySelector(`li[data-filename="${CSS.escape(firstFile)}"]`);
                    }
                }
                if (nextTrackLi) nextTrackLi.click();
            }
        });
        
        infoButton.addEventListener('click', () => {
            infoWindow.style.display = 'flex';
            bringWindowToFront(infoWindow);
        });
        
        // --- Window Button Listeners ---
        
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetWindowId = e.target.dataset.target;
                const windowToClose = document.getElementById(targetWindowId);
                if (windowToClose) {
                    if (targetWindowId === 'player-container') {
                        playerLastX = playerContainer.offsetLeft;
                        playerLastY = playerContainer.offsetTop;
                        playerLastWidth = playerContainer.offsetWidth;
                        playerLastHeight = playerContainer.offsetHeight;
                        playerContainer.style.display = 'none';
                        minimizedPlayerIcon.style.display = 'flex';
                    } else if (targetWindowId === 'dj-app-window') {
                        djLastX = djAppWindow.offsetLeft;
                        djLastY = djAppWindow.offsetTop;
                        djLastWidth = djAppWindow.offsetWidth;
                        djLastHeight = djAppWindow.offsetHeight;
                        djAppWindow.style.display = 'none';
                        minimizedDjIcon.style.display = 'none'; // Hide minimized
                        openDjAppIcon.style.display = 'flex'; // Show open icon
                    } else {
                        windowToClose.style.display = 'none';
                        if (targetWindowId === 'visualizer-window') {
                            stopVisualizer();
                        }
                    }
                }
            });
        });

        minimizePlayerButton.addEventListener('click', () => {
            playerLastX = playerContainer.offsetLeft;
            playerLastY = playerContainer.offsetTop;
            playerLastWidth = playerContainer.offsetWidth;
            playerLastHeight = playerContainer.offsetHeight;
            playerContainer.style.display = 'none';
            minimizedPlayerIcon.style.display = 'flex';
        });

        minimizedPlayerIcon.addEventListener('click', () => {
            playerContainer.style.display = 'flex';
            minimizedPlayerIcon.style.display = 'none';
            bringWindowToFront(playerContainer);
            playerContainer.style.width = playerLastWidth + 'px';
            playerContainer.style.height = playerLastHeight + 'px';
            playerContainer.style.left = playerLastX + 'px';
            playerContainer.style.top = playerLastY + 'px';
        });
        
        // DJ App Minimize/Restore
        openDjAppIcon.addEventListener('click', () => {
            // Calculate and set position *before* showing
            setInitialDjPosition(); 
            djAppWindow.style.display = 'flex';
            openDjAppIcon.style.display = 'none'; // Hide open icon
            minimizedDjIcon.style.display = 'none'; // Hide minimized
            bringWindowToFront(djAppWindow);
            djAppWindow.style.width = djLastWidth + 'px';
            djAppWindow.style.height = djLastHeight + 'px';
            djAppWindow.style.left = djLastX + 'px';
            djAppWindow.style.top = djLastY + 'px';
        });
        
        minimizeDjButton.addEventListener('click', () => {
            djLastX = djAppWindow.offsetLeft;
            djLastY = djAppWindow.offsetTop;
            djLastWidth = djAppWindow.offsetWidth;
            djLastHeight = djAppWindow.offsetHeight;
            djAppWindow.style.display = 'none';
            minimizedDjIcon.style.display = 'flex'; // Show minimized
            openDjAppIcon.style.display = 'none'; // Hide open icon
        });
        
        minimizedDjIcon.addEventListener('click', () => {
            djAppWindow.style.display = 'flex';
            minimizedDjIcon.style.display = 'none'; // Hide minimized
            openDjAppIcon.style.display = 'none'; // Keep open icon hidden
            bringWindowToFront(djAppWindow);
            djAppWindow.style.width = djLastWidth + 'px';
            djAppWindow.style.height = djLastHeight + 'px';
            djAppWindow.style.left = djLastX + 'px';
            djAppWindow.style.top = djLastY + 'px';
        });

        visualizerTabs.addEventListener('click', (e) => {
            const clickedTab = e.target.closest('.visualizer-tab');
            if (clickedTab) {
                document.querySelectorAll('.visualizer-tab').forEach(tab => tab.classList.remove('active'));
                clickedTab.classList.add('active');
                activeVisualizer = clickedTab.dataset.visualizer;
                if (visualizerActive) startVisualizer();
            }
        });
        document.querySelector(`.visualizer-tab[data-visualizer="${activeVisualizer}"]`).classList.add('active');

        // --- Color Conversion Helper (Hex to HSL) ---
        function hexToHSL(H) {
            let r = 0, g = 0, b = 0;
            if (H.length == 4) { r = parseInt(H[1] + H[1], 16); g = parseInt(H[2] + H[2], 16); b = parseInt(H[3] + H[3], 16); }
            else if (H.length == 7) { r = parseInt(H.substring(1, 3), 16); g = parseInt(H.substring(3, 5), 16); b = parseInt(H.substring(5, 7), 16); }
            r /= 255; g /= 255; b /= 255;
            let cmin = Math.min(r,g,b), cmax = Math.max(r,g,b), delta = cmax - cmin, h = 0, s = 0, l = 0;
            if (delta == 0) h = 0; else if (cmax == r) h = ((g - b) / delta) % 6;
            else if (cmax == g) h = (b - r) / delta + 2; else h = (r - g) / delta + 4;
            h = Math.round(h * 60); if (h < 0) h += 360;
            l = (cmax + cmin) / 2;
            s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
            s = +(s * 100).toFixed(1); l = +(l * 100).toFixed(1);
            return {h, s, l};
        }
        function hslToHex(hslColor) {
            let h, s, l;
            if (hslColor.startsWith("#")) {
                const hex = hslColor;
                const r = parseInt(hex.slice(1, 3), 16) / 255;
                const g = parseInt(hex.slice(3, 5), 16) / 255;
                const b = parseInt(hex.slice(5, 7), 16) / 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                h = (max + min) / 2; s = h; l = h;
                if (max == min) { h = 0; s = 0; } 
                else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                return {h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100)};
            } else if (hslColor.startsWith("hsl")) {
                const parts = hslColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
                h = parseInt(parts[1]); s = parseInt(parts[2]); l = parseInt(parts[3]);
                return {h, s, l};
            }
            return {h: 0, s: 0, l: 0};
        }

        // --- Background Color Picker ---
        bgColorPicker.addEventListener('input', (e) => {
            const newColor = e.target.value;
            document.body.style.background = newColor;
            const hsl = hexToHSL(newColor);
            visualizerColor = `hsl(${hsl.h}, 100%, 65%)`;
            secondaryColor = `hsl(${(hsl.h + 180) % 360}, 100%, 65%)`;
        });

        // --- Digital Clock ---
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            digitalClock.textContent = `${hours}:${minutes} ${ampm}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Initial visualizer color sync
        const initialBgColor = bgColorPicker.value;
        const initialHsl = hexToHSL(initialBgColor);
        visualizerColor = `hsl(${initialHsl.h}, 100%, 65%)`;
        secondaryColor = `hsl(${(initialHsl.h + 180) % 360}, 100%, 65%)`;

        // Load the provided image into a hidden img tag to ensure it's loaded for iPhone
        const lockScreenImage = new Image();
        lockScreenImage.src = "cover.png"; // Pulling from the root
        lockScreenImage.style.display = 'none';
        document.body.appendChild(lockScreenImage);
    });
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ilan Reiss Music Player</title>
    
    <!-- Font Awesome for the music icon --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- All CSS is now inside the HTML file --><style>
        /* Import a clean font, 'VT323' for a retro feel or 'Inter' for clean */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            color: #000;
            /* Classic Windows teal background */
            background: #008080;
            overflow: hidden; /* Prevents scrollbars */
            height: 100vh;
            user-select: none; /* Prevent selection during drag/resize */
            -webkit-user-select: none;
        }

        /* --- Reusable Window Style --- */
        .window {
            display: flex;
            flex-direction: column;
            
            /* Classic Windows grey */
            background: #c0c0c0;
            
            /* Classic 3D border */
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            box-shadow: 1px 1px 0 1px #000;
            
            position: absolute;
            min-width: 250px; /* Minimum size */
            min-height: 150px; /* Minimum size */
        }
        
        .player-container {
            width: 90%;
            max-width: 600px;
            height: 70vh;
            max-height: 550px;
        }

        /* The title bar of the player */
        .title-bar {
            padding: 5px 8px;
            font-weight: 700;
            font-size: 1rem;
            color: #fff; 
            /* Classic Windows active title bar */
            background: linear-gradient(to right, #000080, #1084d0);
            cursor: move; /* Indicates this is draggable */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title-bar-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Close button for windows */
        .close-button {
            width: 18px;
            height: 18px;
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 12px;
            font-weight: 900;
            color: #000;
            text-align: center;
            line-height: 16px;
            cursor: pointer;
            margin-left: 5px;
            flex-shrink: 0;
        }
        .close-button:active {
            border-top: 1px solid #404040;
            border-left: 1px solid #404040;
            border-right: 1px solid #fff;
            border-bottom: 1px solid #fff;
        }

        .content {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1; /* Makes content fill the space */
            overflow: hidden; /* Prevents internal scrolling */
            border-top: 1px solid #808080;
        }
        
        .player .content {
             overflow-y: hidden;
        }
        
        .content-inner {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            overflow: hidden;
        }

        /* --- Search Bar Style --- */
        #search-bar {
            width: 100%;
            padding: 8px 10px;
            /* Classic inset border */
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            background: #fff;
            color: #000;
            font-size: 1rem;
            font-weight: 500;
            outline: none;
            flex-shrink: 0;
        }

        #search-bar::placeholder {
            color: #808080;
        }

        /* The scrollable file list */
        .file-browser {
            background: #fff;
            /* Classic inset border */
            border: 2px inset #808080;
            border-top-color: #404040;
            border-left-color: #404040;
            border-right-color: #fff;
            border-bottom-color: #fff;
            padding: 10px;
            flex-grow: 1; 
            overflow-y: auto; /* Adds the scrollbar! */
        }

        #file-list {
            list-style-type: none;
            display: grid; /* Use CSS Grid for the icon layout */
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); /* Auto-responsive columns */
            gap: 15px; /* Space between icons */
        }

        #file-list li {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px;
            border-radius: 0;
            cursor: pointer;
            transition: none; /* Remove transitions */
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            color: #000; /* Text color black */
            background: transparent;
            border: 1px solid transparent; /* For focus */
            height: 100px; /* Fixed height for square look */
        }
        
        #file-list li:hover {
            /* No hover effect, handled by active */
            background: transparent;
        }

        /* The icon part */
        #file-list li .file-icon {
            font-size: 2.5rem; /* Large icon */
            color: #000080; /* Dark Blue */
            margin-bottom: 8px;
            text-shadow: none;
        }

        /* Make icon white on active */
        #file-list li.active .file-icon {
            color: #ffffff;
        }

        /* The file name text */
        .file-name { /* <-- **FIXED** Was "li .file-name" which was less specific */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; /* Ensure text ellipsis works */
            color: #000; /* Black text */
            padding: 2px 4px; /* Give text a background on active */
        }

        /* This class is added by JavaScript to the playing track */
        #file-list li.active {
            background: #000080; /* Dark blue background */
            color: #fff; /* White text */
        }
        
        #file-list li.active .file-name {
             color: #fff;
        }

        .player-controls {
            flex-shrink: 0; /* Prevents this section from shrinking */
        }

        #now-playing {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #000; /* Black text */
            margin-bottom: 10px;
            padding: 5px;
            /* Fade text if too long */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* The audio player itself */
        #audio-player {
            width: 100%;
        }

        /* Custom scrollbar to match the look (simple) */
        ::-webkit-scrollbar {
            width: 16px;
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-track {
            background: #c0c0c0;
        }
        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-top: 1px solid #fff;
            border-left: 1px solid #fff;
            border-right: 1px solid #404040;
            border-bottom: 1px solid #404040;
        }
        
        /* --- New Resize Handle --- */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            /* Simple diagonal line icon */
            background: repeating-linear-gradient(
                -45deg,
                #c0c0c0,
                #c0c0c0 2px,
                #404040 2px,
                #404040 4px,
                #fff 4px,
                #fff 6px
            );
            cursor: nwse-resize;
            z-index: 100;
        }
        
        /* --- New Visualizer Window --- */
        #visualizer-window {
            width: 350px;
            height: 250px; /* Made slightly taller for buttons */
            top: 20px;
            left: 20px;
            display: none; /* Hidden by default */
        }
        
        #visualizer-window .content {
            padding: 5px; /* Reduced padding */
            border: 2px inset #808080; 
            border-top-color: #404040; 
            border-left-color: #404040; 
            border-right-color: #fff; 
            border-bottom-color: #fff;
        }
        
        #viz-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
            flex-shrink: 0;
        }
        
        .viz-btn {
            flex-grow: 1;
            padding: 5px;
            font-size: 0.9rem;
            font-weight: 600;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            cursor: pointer;
        }
        
        .viz-btn:active, .viz-btn.active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            background: #e0e0e0;
        }
        
        #visualizer-canvas {
            width: 100%;
            height: 100%;
            background: #000;
            display: block;
            flex-grow: 1; /* Make canvas fill remaining space */
        }
        
        /* --- New Info Window --- */
        #info-window {
            width: 300px;
            height: 250px;
            top: 150px;
            left: 100px;
            display: none; /* Hidden by default */
        }
        
        #info-window .content {
            padding: 15px;
            font-size: 0.9rem;
        }
        
        #info-button {
            width: 25px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            font-family: "Arial Black", sans-serif;
            font-size: 14px;
            font-weight: 900;
            color: #000080;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
            margin-top: 5px;
            align-self: flex-start;
        }
        #info-button:active {
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
        }

        /* --- New Digital Clock --- */
        #digital-clock {
            position: fixed;
            bottom: 0;
            right: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            font-size: 1rem;
            font-weight: 600;
            z-index: 1000;
            border-bottom: none; /* Sits on bottom edge */
            border-right: none; /* Sits on right edge */
        }
        
        /* --- New Color Picker --- */
        #color-picker-container {
            position: fixed;
            bottom: 0;
            left: 0;
            background: #c0c0c0;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            border-right: 2px solid #404040;
            border-bottom: 2px solid #404040;
            padding: 5px 10px;
            z-index: 1000;
            border-bottom: none; /* Sits on bottom edge */
            border-left: none; /* Sits on left edge */
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #color-picker-container label {
            font-size: 1rem;
            font-weight: 600;
        }
        
        #bg-color-picker {
            width: 40px;
            height: 25px;
            background: #c0c0c0;
            border-top: 2px solid #404040;
            border-left: 2px solid #404040;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            cursor: pointer;
            padding: 0; /* Remove default padding */
        }
        
        /* Webkit specific styles for color input */
        #bg-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        #bg-color-picker::-webkit-color-swatch {
            border: none;
        }
    </style>
</head>
<body>

    <!-- The "Old Computer" Player --><div class="player-container window">
        <div class="title-bar">
            <span class="title-bar-text">üéµ Ilan Reiss Music Player</span>
        </div>
        
        <div class="content">
            <div class="player-controls">
                <span id="now-playing">Select a track to play</span>
                
                <!-- Added 'crossorigin' back for visualizer --><audio id="audio-player" controls crossorigin="anonymous"></audio>
            </div>
            
            <div class="content-inner">
                <input type="text" id="search-bar" placeholder="Search tracks...">

                <div class="file-browser">
                    <ul id="file-list">
                        <!-- The list of files will appear here --></ul>
                </div>
                 <button id="info-button">i</button>
            </div>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <!-- New Visualizer Window -->
    <div id="visualizer-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">üîä Audio Visualizer</span>
            <span class="close-button" data-target="visualizer-window">X</span>
        </div>
        <div class="content">
            <div id="viz-controls">
                <button class="viz-btn active" data-mode="particles">Particles</button>
                <button class="viz-btn" data-mode="oscilloscope">Scope</button>
                <button class="viz-btn" data-mode="synthwave">80s</button>
            </div>
            <canvas id="visualizer-canvas"></canvas>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <!-- New Info Window -->
    <div id="info-window" class="window">
         <div class="title-bar">
            <span class="title-bar-text">‚ÑπÔ∏è Information</span>
            <span class="close-button" data-target="info-window">X</span>
        </div>
        <div class="content">
            <p><strong>Ilan Reiss Music Player</strong></p>
            <p>Version 1.1 (Retro)</p>
            <br>
            <p>This music player streams files directly from the 'Audio' folder of the GitHub repository.</p>
            <br>
            <p><em>(You can edit this text in the ilanreissmusic.com.html file)</em></p>
        </div>
        <div class="resize-handle"></div>
    </div>
    
    <!-- New Digital Clock -->
    <div id="digital-clock">9:31 PM</div>

    <!-- New Color Picker -->
    <div id="color-picker-container">
        <label for="bg-color-picker">BG:</label>
        <input type="color" id="bg-color-picker" value="#008080">
    </div>

    <!-- All JavaScript is now inside the HTML file --><script>
        // This function runs once the entire HTML page has loaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- AUDIO FILE LIST ---
            const audioFiles = [
                "2 part shit.mp3", "42 cent.mp3", "67.mp3", "808 beat sample.mp3",
                "a break.mp3", "all me.mp3", "another one.mp3", "asher organ.mp3",
                "ass with potench.mp3", "bad one.mp3", "been a minu.mp3", "beeps.mp3",
                "before my set.mp3", "before you go.mp3", "black airforces.mp3",
                "bubs final.mp3", "bubs.mp3", "buds.mp3", "bullshittin.mp3",
                "candy shack.mp3", "chicos.mp3", "chilled.mp3", "com 303 sh.mp3",
                "corp. rework.mp3", "corp..mp3", "cya.mp3", "cypher chopped.mp3",
                "danklin.mp3", "day ones.mp3", "day today .mp3", "delete this track.mp3",
                "dub w.mp3", "easter.mp3", "ff.mp3", "flip.mp3", "fly guy.mp3",
                "for it.mp3", "for the car.mp3", "fridays.mp3", "fuckin idk.mp3",
                "funky.mp3", "gallery lazy break.mp3", "gallery.mp3", "giving in.mp3",
                "go 2.mp3", "goin crazy wit 10 racks.mp3", "goin crazy with 10 racks.mp3",
                "golf soundscape.mp3", "gover.mp3", "grizzlies ART.mp3", "grizzlies.mp3",
                "half life beat.mp3", "hammer down.mp3", "have it.mp3", "have to save.mp3",
                "hit the cart.mp3", "House on plane.mp3", "huh.mp3", "hyper fix.mp3",
                "i wanna.mp3", "insanity.mp3", "is ass.mp3", "jungled.mp3", "kenny.mp3",
                "kirked.mp3", "last of day.mp3", "lastly.mp3", "late.mp3", "lib beat.mp3",
                "locked.mp3", "lost it unfinished.mp3", "lyra demo.mp3", "ma.mp3",
                "making progress thru.mp3", "making progress.mp3", "mini 808.mp3",
                "MPC iPhone beat.mp3", "my amigo.mp3", "my sound scape.mp3",
                "new jersey club.mp3", "new setup.mp3", "niko again .mp3",
                "niko again unfinished.mp3", "niko is talking.mp3", "not done beat.mp3",
                "not thru.mp3", "not trash.mp3", "null.mp3", "number 3 shit.mp3",
                "On plane shiz.mp3", "postd.mp3", "practice.mp3", "quiky.mp3",
                "rabbits.mp3", "read up.mp3", "recipe.mp3", "redo.mp3", "reggae.mp3",
                "reggetons.mp3", "Reiss_Soundscape_edit.mp3", "Reiss_soundscape_raw.mp3",
                "rick poppa.mp3", "rythm.mp3", "same goal.mp3", "saturday morning.mp3",
                "saturn.mp3", "save rq.mp3", "saved it.mp3", "serup.mp3",
                "shit is trash.mp3", "shortest beat.mp3", "show class.mp3",
                "show trash.mp3", "slash slowed.mp3", "slash.mp3", "slow jam 2.mp3",
                "slow ride.mp3", "snippes.mp3", "soundbath 2.mp3", "soundbath.mp3",
                "SP iPhone sample.mp3", "spit it out.mp3", "standing in the rain.mp3",
                "starterd.mp3", "sue nami.mp3", "surfin.mp3", "swang.mp3",
                "swing song w eli.mp3", "synth demo.mp3", "take 2.mp3", "techno.mp3",
                "that way.mp3", "the monitor.mp3", "the worst beat ever.mp3",
                "this again.mp3", "threw together.mp3", "throw it up.mp3",
                "thursday.mp3", "trios.mp3", "trump-pets.mp3", "un house.mp3",
                "w issy.mp3", "watch it go.mp3", "week from today.mp3",
                "what am i doing.mp3", "what is this.mp3", "z style.mp3"
            ];

            // --- ELEMENT REFERENCES ---
            const audioPlayer = document.getElementById('audio-player');
            const fileListElement = document.getElementById('file-list');
            const nowPlayingElement = document.getElementById('now-playing');
            const searchBar = document.getElementById('search-bar');
            
            const playerContainer = document.querySelector('.player-container');
            const visualizerWindow = document.getElementById('visualizer-window');
            const infoWindow = document.getElementById('info-window');
            const infoButton = document.getElementById('info-button');
            const digitalClock = document.getElementById('digital-clock');
            const bgColorPicker = document.getElementById('bg-color-picker');
            
            const canvas = document.getElementById('visualizer-canvas');
            const ctx = canvas.getContext('2d');
            const vizControls = document.getElementById('viz-controls');
            
            let visualizerColor = '#00FFFF'; // Initial color (cyan)
            let currentVizMode = 'particles'; // Default viz mode

            // --- Particle System ---
            let particles = [];
            const maxParticles = 150; // More particles

            function Particle(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = (Math.random() * 3) + 0.5; // Random speed
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.life = Math.random() * 100 + 50; // 50-150 frames
                this.size = Math.random() * 3 + 1; // 1-4px
            }

            Particle.prototype.update = function() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 1;
                this.vx *= 0.99;
                this.vy *= 0.99;
            };

            Particle.prototype.draw = function(ctx) {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = Math.max(0, this.life / 100); // Fade out
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            };
            // --- End Particle System ---


            // --- AUDIO VISUALIZER SETUP ---
            let audioContext, analyser, source, dataArray, bufferLength;
            let visualizerActive = false;

            function setupVisualizer() {
                if (audioContext) return; // Already set up
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                // Set initial fftSize, will be changed by drawVisualizer
                analyser.fftSize = 256; 
                
                source = audioContext.createMediaElementSource(audioPlayer);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                visualizerWindow.style.display = 'flex'; // Show visualizer
                visualizerActive = true;
                drawVisualizer();
            }
            
            // --- MAIN DRAW LOOP (Router) ---
            function drawVisualizer() {
                if (!visualizerActive) return;
                
                requestAnimationFrame(drawVisualizer);
                
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                
                switch (currentVizMode) {
                    case 'particles':
                        // Ensure correct analyser settings for this mode
                        if (analyser.fftSize !== 256) analyser.fftSize = 256;
                        bufferLength = analyser.frequencyBinCount; // 128
                        if (dataArray.length !== bufferLength) dataArray = new Uint8Array(bufferLength);
                        
                        analyser.getByteFrequencyData(dataArray); // Get data
                        drawVizParticles(); // Draw
                        break;
                        
                    case 'oscilloscope':
                        // Ensure correct analyser settings for this mode
                        if (analyser.fftSize !== 2048) analyser.fftSize = 2048;
                        bufferLength = analyser.frequencyBinCount; // 1024
                        if (dataArray.length !== bufferLength) dataArray = new Uint8Array(bufferLength);
                        
                        analyser.getByteTimeDomainData(dataArray); // Get data
                        drawVizOscilloscope(); // Draw
                        break;
                        
                    case 'synthwave':
                         // Ensure correct analyser settings for this mode
                        if (analyser.fftSize !== 256) analyser.fftSize = 256;
                        bufferLength = analyser.frequencyBinCount; // 128
                        if (dataArray.length !== bufferLength) dataArray = new Uint8Array(bufferLength);
                        
                        analyser.getByteFrequencyData(dataArray); // Get data
                        drawVizSynthwave(); // Draw
                        break;
                }
            }

            // --- VIZ MODE 1: PARTICLES ---
            function drawVizParticles() {
                // Fading effect for particle trails
                ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Slower fade for trails
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                let bass = 0;
                let mids = 0;
                const bassEnd = Math.floor(bufferLength * 0.2); // ~25 bins
                const midsEnd = Math.floor(bufferLength * 0.6); // ~76 bins
                
                for (let i = 0; i < bufferLength; i++) {
                    if (i < bassEnd) bass += dataArray[i];
                    else if (i < midsEnd) mids += dataArray[i];
                }
                let bassAvg = (bass / bassEnd) || 0;
                let midsAvg = (mids / (midsEnd - bassEnd)) || 0;
                
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;

                const spawnRate = Math.floor(midsAvg / 50); // 0-5 particles per frame
                if (particles.length < maxParticles) { 
                    for (let i = 0; i < spawnRate; i++) {
                        particles.push(new Particle(centerX, centerY, visualizerColor));
                    }
                }
                
                ctx.globalAlpha = 1.0;
                for (let i = particles.length - 1; i >= 0; i--) {
                    particles[i].update();
                    particles[i].draw(ctx);
                    if (particles[i].life <= 0 || 
                        particles[i].x < -particles[i].size || particles[i].x > canvas.width + particles[i].size || 
                        particles[i].y < -particles[i].size || particles[i].y > canvas.height + particles[i].size) 
                    {
                        particles.splice(i, 1);
                    }
                }
                
                const radiusMod = (bassAvg / 255) * (canvas.height / 8);
                const baseRadius = canvas.height / 10;
                const currentRadius = baseRadius + radiusMod;
                
                ctx.shadowColor = visualizerColor;
                ctx.shadowBlur = 30;
                ctx.strokeStyle = visualizerColor;
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(centerX, centerY, currentRadius, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.lineWidth = 1;
                ctx.globalAlpha = 0.3;
                ctx.fillStyle = visualizerColor;
                ctx.beginPath();
                ctx.arc(centerX, centerY, Math.max(0, currentRadius * 0.9), 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = 1.0;
                ctx.shadowBlur = 0;
            }
            
            // --- VIZ MODE 2: OSCILLOSCOPE ---
            function drawVizOscilloscope() {
                ctx.fillStyle = '#000'; // Black background
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#00FF00'; // Classic green
                ctx.shadowColor = '#00FF00';
                ctx.shadowBlur = 10;
                
                ctx.beginPath();
                
                const sliceWidth = (canvas.width * 1.0) / bufferLength;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0; // 0-255 -> 0.0-2.0
                    const y = (v * canvas.height) / 2; 

                    if(i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    
                    x += sliceWidth;
                }

                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();
                ctx.shadowBlur = 0; 
            }
            
            // --- VIZ MODE 3: 80s SYNTHWAVE ---
            let roadOffset = 0; // For "driving" effect
            function drawVizSynthwave() {
                let bass = 0;
                let mids = 0;
                const bassEnd = Math.floor(bufferLength * 0.2); // ~25 bins
                const midsEnd = Math.floor(bufferLength * 0.6); // ~76 bins
                
                for (let i = 0; i < bufferLength; i++) {
                    if (i < bassEnd) bass += dataArray[i];
                    else if (i < midsEnd) mids += dataArray[i];
                }
                let bassAvg = (bass / bassEnd) || 0; // 0-255
                let midsAvg = (mids / (midsEnd - bassEnd)) || 0; // 0-255
                
                const w = canvas.width;
                const h = canvas.height;
                const horizonY = h * 0.6;
                const horizonBounce = (midsAvg / 255) * 15; // Max 15px bounce
                
                // 1. Draw Sky
                const skyGrad = ctx.createLinearGradient(0, 0, 0, horizonY);
                skyGrad.addColorStop(0, '#1a023a'); // Dark purple
                skyGrad.addColorStop(1, '#ff0080'); // Hot pink
                ctx.fillStyle = skyGrad;
                ctx.fillRect(0, 0, w, horizonY);
                
                // 2. Draw Sun
                const sunRadius = h / 10;
                const sunY = horizonY - sunRadius * 0.3;
                const sunGrad = ctx.createRadialGradient(w/2, sunY, sunRadius * 0.1, w/2, sunY, sunRadius);
                sunGrad.addColorStop(0, '#ffff00');
                sunGrad.addColorStop(0.5, '#ff8000');
                sunGrad.addColorStop(1, 'rgba(255, 0, 128, 0)');
                ctx.fillStyle = sunGrad;
                ctx.fillRect(0, 0, w, horizonY); // Clip to sky
                
                // 3. Draw Ground
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, horizonY, w, h - horizonY);
                
                // 4. Draw Road Grid
                ctx.strokeStyle = visualizerColor; // Use dynamic color
                ctx.shadowColor = visualizerColor;
                ctx.shadowBlur = 15;
                ctx.lineWidth = 1;
                
                roadOffset = (roadOffset + 2) % 40; // Animate road lines
                
                for(let i = -20; i < 20; i++) {
                    // Horizontal lines
                    const y = horizonY + Math.pow(i/20, 2) * (h - horizonY) + (roadOffset / 40) * (h-horizonY)/20;
                    if (y < h) {
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(w, y);
                        ctx.globalAlpha = 1 - (y - horizonY) / (h - horizonY); // Fade out
                        ctx.stroke();
                    }
                }
                // Vertical lines (perspective)
                for(let i = -10; i <= 10; i++) {
                    const x1 = w/2 + (i * w/20);
                    const y1 = horizonY;
                    const x2 = w/2 + (i * w/2);
                    const y2 = h;
                    
                    ctx.beginPath();
                    ctx.moveTo(x1, y1 + horizonBounce); // Make horizon bounce
                    ctx.lineTo(x2, y2);
                    ctx.globalAlpha = 1;
                    ctx.stroke();
                }
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1;

                // 5. Draw Speakers
                const speakerW = w / 5;
                const speakerH = h / 3;
                const speakerY = h - speakerH;
                const wooferPulse = (bassAvg / 255) * (speakerW / 8); // Pulse radius
                
                // Left Speaker
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, speakerY, speakerW, speakerH);
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(speakerW/2, speakerY + speakerH/2, speakerW/3 + wooferPulse, 0, Math.PI*2);
                ctx.fill();
                
                // Right Speaker
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(w - speakerW, speakerY, speakerW, speakerH);
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(w - speakerW/2, speakerY + speakerH/2, speakerW/3 + wooferPulse, 0, Math.PI*2);
                ctx.fill();
            }
            
            // --- VIZ MODE SWITCHER ---
            vizControls.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    // Update active class
                    vizControls.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    // Set mode
                    currentVizMode = e.target.dataset.mode;
                    
                    // Reset particles if switching away
                    if(currentVizMode !== 'particles') {
                        particles = [];
                    }
                }
            });


            // --- WINDOW MANAGEMENT FUNCTIONS ---
            function makeWindowDraggable(windowEl) {
                const titleBar = windowEl.querySelector('.title-bar');
                let isDragging = false;
                let offsetX, offsetY;
                
                titleBar.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('close-button')) return;
                    isDragging = true;
                    offsetX = e.clientX - windowEl.offsetLeft;
                    offsetY = e.clientY - windowEl.offsetTop;
                    document.body.style.cursor = 'move';
                    e.preventDefault();
                });
                
                titleBar.addEventListener('touchstart', (e) => {
                    if (e.target.classList.contains('close-button')) return;
                    isDragging = true;
                    const touch = e.touches[0];
                    offsetX = touch.clientX - windowEl.offsetLeft;
                    offsetY = touch.clientY - windowEl.offsetTop;
                    e.preventDefault();
                }, { passive: false });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    document.body.style.cursor = 'default';
                });
                
                document.addEventListener('touchend', () => {
                    isDragging = false;
                    document.body.style.cursor = 'default';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    let newX = e.clientX - offsetX;
                    let newY = e.clientY - offsetY;
                    newX = Math.max(0, Math.min(newX, window.innerWidth - windowEl.offsetWidth));
                    newY = Math.max(0, Math.min(newY, window.innerHeight - windowEl.offsetHeight));
                    windowEl.style.left = newX + 'px';
                    windowEl.style.top = newY + 'px';
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    const touch = e.touches[0];
                    let newX = touch.clientX - offsetX;
                    let newY = touch.clientY - offsetY;
                    newX = Math.max(0, Math.min(newX, window.innerWidth - windowEl.offsetWidth));
                    newY = Math.max(0, Math.min(newY, window.innerHeight - windowEl.offsetHeight));
                    windowEl.style.left = newX + 'px';
                    windowEl.style.top = newY + 'px';
                    e.preventDefault();
                }, { passive: false });
            }

            function makeWindowResizable(windowEl) {
                const resizeHandle = windowEl.querySelector('.resize-handle');
                if (!resizeHandle) return; // Guard clause
                let isResizing = false;

                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    document.body.style.cursor = 'nwse-resize';
                    e.preventDefault();
                });
                
                resizeHandle.addEventListener('touchstart', (e) => {
                    isResizing = true;
                    e.preventDefault();
                }, { passive: false });

                document.addEventListener('mouseup', () => {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                });
                
                document.addEventListener('touchend', () => {
                    isResizing = false;
                    document.body.style.cursor = 'default';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    let newWidth = e.clientX - windowEl.offsetLeft;
                    let newHeight = e.clientY - windowEl.offsetTop;
                    newWidth = Math.max(250, newWidth);
                    newHeight = Math.max(150, newHeight);
                    windowEl.style.width = newWidth + 'px';
                    windowEl.style.height = newHeight + 'px';
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (!isResizing) return;
                    const touch = e.touches[0];
                    let newWidth = touch.clientX - windowEl.offsetLeft;
                    let newHeight = touch.clientY - windowEl.offsetTop;
                    newWidth = Math.max(250, newWidth);
                    newHeight = Math.max(150, newHeight);
                    windowEl.style.width = newWidth + 'px';
                    windowEl.style.height = newHeight + 'px';
                    e.preventDefault();
                }, { passive: false });
            }

            // --- INITIALIZE WINDOWS ---
            [playerContainer, visualizerWindow, infoWindow].forEach(makeWindowDraggable);
            [playerContainer, visualizerWindow, infoWindow].forEach(makeWindowResizable);

            // Center main player window on load
            playerContainer.style.left = (window.innerWidth - playerContainer.offsetWidth) / 2 + 'px';
            playerContainer.style.top = (window.innerHeight - playerContainer.offsetHeight) / 2 + 'px';
            
            visualizerWindow.style.left = '20px';
            visualizerWindow.style.top = '20px';
            infoWindow.style.left = (window.innerWidth - 300) / 2 + 'px';
            infoWindow.style.top = (window.innerHeight - 250) / 2 + 'px';


            // --- POPULATE FILE LIST ---
            audioFiles.forEach(file => {
                const li = document.createElement('li');
                // **FIXED** class="file-name"
                li.innerHTML = `
                    <i class="fas fa-music file-icon"></i>
                    <span class="file-name">${file.replace('.mp3', '')}</span>
                `;
                li.dataset.filename = file;
                fileListElement.appendChild(li);
            });

            // --- EVENT LISTENERS ---

            // File click
            fileListElement.addEventListener('click', (event) => {
                const clickedLi = event.target.closest('li');
                if (clickedLi) {
                    const filename = clickedLi.dataset.filename;
                    
                    audioPlayer.src = 'Audio/' + filename;
                    
                    if (!audioContext) {
                        setupVisualizer();
                    } else if (audioContext.state === 'suspended') {
                         audioContext.resume();
                    }
                    
                    audioPlayer.play();
                    
                    const trackName = clickedLi.querySelector('.file-name').textContent;
                    nowPlayingElement.textContent = trackName;
                    
                    // --- NEW: Media Session API for Lock Screen ---
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: trackName,
                            artist: 'Ilan Reiss',
                            album: 'Ilan Reiss Music Player',
                            artwork: [
                                // Simple Data URI for a music note icon
                                { 
                                  src: 'data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="white"><rect width="100" height="100" fill="black"/><path d="M45,65 L45,20 C45,15 50,15 50,20 L50,50 L70,45 C75,44 76,51 71,52 L50,57 L50,65 C50,75 40,77 35,70 C30,63 30,55 40,55 C43,55 45,57 45,60 L45,65 Z M35,65 C33,65 33,63 35,63 C37,63 37,65 35,65 Z"/></svg>', 
                                  type: 'image/svg+xml' 
                                }
                            ]
                        });
                    }
                    // --- End Media Session ---
                    
                    const currentActive = fileListElement.querySelector('.active');
                    if (currentActive) {
                        currentActive.classList.remove('active');
                    }
                    clickedLi.classList.add('active');
                    
                    visualizerWindow.style.display = 'flex';
                    visualizerActive = true;
                    if (audioContext.state === 'suspended') {
                        audioContext.resume().then(drawVisualizer);
                    } else {
                        drawVisualizer(); // Start loop
                    }
                }
            });
            
            audioPlayer.addEventListener('pause', () => {
                visualizerActive = false;
            });
            
             audioPlayer.addEventListener('play', () => {
                if (audioContext) { 
                    audioContext.resume();
                    visualizerActive = true;
                    drawVisualizer(); 
                }
            });

            // Search bar
            searchBar.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                fileListElement.querySelectorAll('li').forEach(fileLi => {
                    const fileName = fileLi.querySelector('.file-name').textContent.toLowerCase();
                    fileLi.style.display = fileName.includes(searchTerm) ? 'flex' : 'none';
                });
            });

            // Autoplay next
            audioPlayer.addEventListener('ended', () => {
                const currentActive = fileListElement.querySelector('.active');
                if (currentActive) {
                    let nextTrack = currentActive.nextElementSibling;
                    if (!nextTrack) {
                        nextTrack = fileListElement.firstElementChild;
                    }
                    if (nextTrack) {
                        nextTrack.click();
                    }
                }
            });
            
            infoButton.addEventListener('click', () => {
                infoWindow.style.display = 'flex';
            });
            
            document.querySelectorAll('.close-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetWindowId = e.target.dataset.target;
                    const windowToClose = document.getElementById(targetWindowId);
                    if (windowToClose) {
                        windowToClose.style.display = 'none';
                        if (targetWindowId === 'visualizer-window') {
                            visualizerActive = false; 
                        }
                    }
                });
            });
            
            function hexToHSL(H) {
                let r = 0, g = 0, b = 0;
                if (H.length == 4) {
                    r = "0x" + H[1] + H[1];
                    g = "0x" + H[2] + H[2];
                    b = "0x" + H[3] + H[3];
                } else if (H.length == 7) {
                    r = "0x" + H[1] + H[2];
                    g = "0x" + H[3] + H[4];
                    b = "0x" + H[5] + H[6];
                }
                r /= 255; g /= 255; b /= 255;
                let cmin = Math.min(r,g,b),
                    cmax = Math.max(r,g,b),
                    delta = cmax - cmin,
                    h = 0, s = 0, l = 0;
                if (delta == 0) h = 0;
                else if (cmax == r) h = ((g - b) / delta) % 6;
                else if (cmax == g) h = (b - r) / delta + 2;
                else h = (r - g) / delta + 4;
                h = Math.round(h * 60);
                if (h < 0) h += 360;
                l = (cmax + cmin) / 2;
                s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
                s = +(s * 100).toFixed(1);
                l = +(l * 100).toFixed(1);
                return {h, s, l};
            }

            bgColorPicker.addEventListener('input', (e) => {
                const newColor = e.target.value;
                document.body.style.background = newColor;
                const hsl = hexToHSL(newColor);
                visualizerColor = `hsl(${hsl.h}, 100%, 65%)`;
            });

            function updateClock() {
                const now = new Date();
                let hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 hour should be 12
                digitalClock.textContent = `${hours}:${minutes} ${ampm}`;
            }
            setInterval(updateClock, 1000);
            updateClock(); // Initial call
        });
    </script>
</body>
